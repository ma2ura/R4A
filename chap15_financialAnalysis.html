<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.529">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>財務分析</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="chap15_financialAnalysis_files/libs/clipboard/clipboard.min.js"></script>
<script src="chap15_financialAnalysis_files/libs/quarto-html/quarto.js"></script>
<script src="chap15_financialAnalysis_files/libs/quarto-html/popper.min.js"></script>
<script src="chap15_financialAnalysis_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="chap15_financialAnalysis_files/libs/quarto-html/anchor.min.js"></script>
<link href="chap15_financialAnalysis_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="chap15_financialAnalysis_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="chap15_financialAnalysis_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="chap15_financialAnalysis_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="chap15_financialAnalysis_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">財務分析</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>この章では、よく財務分析の教科書に登場する財務比率(financial ratio)の使い方や計算方法について説明します。 財務比率は、企業の財務状態を把握するための指標であり、企業の経営者や投資家、債権者、株主などが企業の財務状態を判断するために利用します。</p>
<p>財務比率は、企業の財務諸表項目の分数で表されるため、<code>group_by()</code>関数や<code>mutate()</code>関数を使うことで簡単に計算することができます。</p>
<p>分析対象とする企業は，</p>
<ul>
<li>2010年度から2023年度までに期間に，</li>
<li>東京証券取引所のプライム・スタンダード・グロース市場に上場し，</li>
<li>従業員数が500名以上いる企業</li>
</ul>
<p>とします。 この章で用いる会計項目は，</p>
<ul>
<li><code>R001</code> 決算月数</li>
<li><code>R018</code> 上場場部：コード</li>
<li><code>R022</code> 日経業種：コード</li>
<li><code>B063</code> 有形固定資産</li>
<li><code>B110</code> 資産合計</li>
<li><code>D021</code> 売上高・営業収益</li>
<li><code>D101</code> 法人税等</li>
<li><code>D103</code> 法人税等調整額</li>
<li><code>D047</code> 支払利息・割引料</li>
<li><code>D110</code> 親会社株主に帰属する当期純利益</li>
<li><code>K075</code> [販管費] 人件費・福利厚生費</li>
<li><code>K079</code> [販管費] 賃借料</li>
<li><code>H021</code> 期末従業員数</li>
</ul>
<p>です。 日経NEEDS社会科学情報検索システムでデータを集めるときは，以下の項目コードを使ってください。</p>
<pre><code>R001,R018,R022,B063,B110,D021,D101,D103,D047,D110,K075,K079,H021</code></pre>
<section id="データの読み込みと前処理" class="level3">
<h3 class="anchored" data-anchor-id="データの読み込みと前処理">データの読み込みと前処理</h3>
<p>まずはCSVデータを読み込みます。</p>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Macユーザーへの注意点
</div>
</div>
<div class="callout-body-container callout-body">
<p>日経NEEDS社会科学情報検索システムからダウンロードしたデータは，文字コードがShift-JISであるため，UTF-8を基本とするMacだと<code>read_csv</code>関数でそのまま読み込むと文字化けします。 そのため，<code>read_csv</code>関数の<code>locale</code>引数で<code>locale(encoding = "Shift_JIS")</code>を指定して読み込む必要があります。</p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># df &lt;- read_csv("https://so-ichi.com/presemi_part_two.csv")</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"data/TSE_2010_EMP500.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Rows: 27174 Columns: 18
── Column specification ────────────────────────────────────────────────────────
Delimiter: ","
chr  (3): 日経会社コード, 企業名称, 決算期
dbl (15): 決算種別, 連結基準, 期末従業員数, 決算月数, 上場場部：コード, 日経業種：コード, 資産合計, 有形固定資産, 【販管費】人...

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
</div>
</div>
<p>日経NEEDSからダウンロードしたデータの変数名が長いので，半角英数の分かりやすい変数名に変更します。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># renameで変数名を変更</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> df <span class="sc">|&gt;</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">nikkei_code =</span> <span class="st">"日経会社コード"</span>,</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"企業名称"</span>,</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">date =</span> <span class="st">"決算期"</span>,</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">kessan =</span> <span class="st">"決算種別"</span>,</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">renketsu =</span> <span class="st">"連結基準"</span>,</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">num_employee =</span> <span class="st">"期末従業員数"</span>,</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">kessan_month =</span> <span class="st">"決算月数"</span>,</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">listed_code =</span> <span class="st">"上場場部：コード"</span>,</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">industry_code =</span> <span class="st">"日経業種：コード"</span>,</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">total_asset =</span> <span class="st">"資産合計"</span>,</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">tangibles =</span>  <span class="st">"有形固定資産"</span>,</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">salary =</span>  <span class="st">"【販管費】人件費・福利厚生費［累計］"</span>,</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">rent_fee =</span> <span class="st">"【販管費】賃借料［累計］"</span>,</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">corporate_tax =</span> <span class="st">"法人税等［累計］"</span>,</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">tax_adjustment =</span> <span class="st">"法人税等調整額／繰延税金費用［累計］"</span>,</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">net_income =</span>   <span class="st">"親会社株主に帰属する当期純利益（連結）／当期利益（単独）［累計］"</span>,</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">interest_expense =</span> <span class="st">"支払利息・割引料［累計］"</span>,</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">sales =</span> <span class="st">"売上高・営業収益［累計］"</span></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><code>head()</code>関数や<code>summary()</code>関数でデータの中身を確認します。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table" style="margin-left: auto; margin-right: auto;">
<thead>
<tr>
<th style="text-align:left;">
nikkei_code
</th>
<th style="text-align:left;">
name
</th>
<th style="text-align:left;">
date
</th>
<th style="text-align:right;">
kessan
</th>
<th style="text-align:right;">
renketsu
</th>
<th style="text-align:right;">
num_employee
</th>
<th style="text-align:right;">
kessan_month
</th>
<th style="text-align:right;">
listed_code
</th>
<th style="text-align:right;">
industry_code
</th>
<th style="text-align:right;">
total_asset
</th>
<th style="text-align:right;">
tangibles
</th>
<th style="text-align:right;">
salary
</th>
<th style="text-align:right;">
rent_fee
</th>
<th style="text-align:right;">
corporate_tax
</th>
<th style="text-align:right;">
tax_adjustment
</th>
<th style="text-align:right;">
net_income
</th>
<th style="text-align:right;">
interest_expense
</th>
<th style="text-align:right;">
sales
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
0000001
</td>
<td style="text-align:left;">
極洋
</td>
<td style="text-align:left;">
2010/03
</td>
<td style="text-align:right;">
10
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
2909
</td>
<td style="text-align:right;">
12
</td>
<td style="text-align:right;">
11
</td>
<td style="text-align:right;">
235341
</td>
<td style="text-align:right;">
64301
</td>
<td style="text-align:right;">
11568
</td>
<td style="text-align:right;">
3955
</td>
<td style="text-align:right;">
NA
</td>
<td style="text-align:right;">
923
</td>
<td style="text-align:right;">
-281
</td>
<td style="text-align:right;">
1086
</td>
<td style="text-align:right;">
364
</td>
<td style="text-align:right;">
145778
</td>
</tr>
<tr>
<td style="text-align:left;">
0000001
</td>
<td style="text-align:left;">
極洋
</td>
<td style="text-align:left;">
2011/03
</td>
<td style="text-align:right;">
10
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
2753
</td>
<td style="text-align:right;">
12
</td>
<td style="text-align:right;">
11
</td>
<td style="text-align:right;">
235341
</td>
<td style="text-align:right;">
76925
</td>
<td style="text-align:right;">
12331
</td>
<td style="text-align:right;">
4261
</td>
<td style="text-align:right;">
NA
</td>
<td style="text-align:right;">
799
</td>
<td style="text-align:right;">
-396
</td>
<td style="text-align:right;">
58
</td>
<td style="text-align:right;">
380
</td>
<td style="text-align:right;">
162731
</td>
</tr>
<tr>
<td style="text-align:left;">
0000001
</td>
<td style="text-align:left;">
極洋
</td>
<td style="text-align:left;">
2012/03
</td>
<td style="text-align:right;">
10
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
2460
</td>
<td style="text-align:right;">
12
</td>
<td style="text-align:right;">
11
</td>
<td style="text-align:right;">
235341
</td>
<td style="text-align:right;">
84937
</td>
<td style="text-align:right;">
11574
</td>
<td style="text-align:right;">
4476
</td>
<td style="text-align:right;">
NA
</td>
<td style="text-align:right;">
1383
</td>
<td style="text-align:right;">
-62
</td>
<td style="text-align:right;">
423
</td>
<td style="text-align:right;">
419
</td>
<td style="text-align:right;">
181885
</td>
</tr>
<tr>
<td style="text-align:left;">
0000001
</td>
<td style="text-align:left;">
極洋
</td>
<td style="text-align:left;">
2013/03
</td>
<td style="text-align:right;">
10
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
2397
</td>
<td style="text-align:right;">
12
</td>
<td style="text-align:right;">
11
</td>
<td style="text-align:right;">
235341
</td>
<td style="text-align:right;">
83245
</td>
<td style="text-align:right;">
11281
</td>
<td style="text-align:right;">
4571
</td>
<td style="text-align:right;">
NA
</td>
<td style="text-align:right;">
1139
</td>
<td style="text-align:right;">
-441
</td>
<td style="text-align:right;">
1269
</td>
<td style="text-align:right;">
376
</td>
<td style="text-align:right;">
178046
</td>
</tr>
<tr>
<td style="text-align:left;">
0000001
</td>
<td style="text-align:left;">
極洋
</td>
<td style="text-align:left;">
2014/03
</td>
<td style="text-align:right;">
10
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
2111
</td>
<td style="text-align:right;">
12
</td>
<td style="text-align:right;">
11
</td>
<td style="text-align:right;">
235341
</td>
<td style="text-align:right;">
84319
</td>
<td style="text-align:right;">
10597
</td>
<td style="text-align:right;">
4466
</td>
<td style="text-align:right;">
NA
</td>
<td style="text-align:right;">
1255
</td>
<td style="text-align:right;">
284
</td>
<td style="text-align:right;">
2968
</td>
<td style="text-align:right;">
385
</td>
<td style="text-align:right;">
202387
</td>
</tr>
<tr>
<td style="text-align:left;">
0000001
</td>
<td style="text-align:left;">
極洋
</td>
<td style="text-align:left;">
2015/03
</td>
<td style="text-align:right;">
10
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
2169
</td>
<td style="text-align:right;">
12
</td>
<td style="text-align:right;">
11
</td>
<td style="text-align:right;">
235341
</td>
<td style="text-align:right;">
88937
</td>
<td style="text-align:right;">
12241
</td>
<td style="text-align:right;">
4628
</td>
<td style="text-align:right;">
NA
</td>
<td style="text-align:right;">
2389
</td>
<td style="text-align:right;">
1216
</td>
<td style="text-align:right;">
2433
</td>
<td style="text-align:right;">
408
</td>
<td style="text-align:right;">
218350
</td>
</tr>
</tbody>
</table>
</div>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> nikkei_code            name               date               kessan  
 Length:27174       Length:27174       Length:27174       Min.   :10  
 Class :character   Class :character   Class :character   1st Qu.:10  
 Mode  :character   Mode  :character   Mode  :character   Median :10  
                                                          Mean   :10  
                                                          3rd Qu.:10  
                                                          Max.   :10  
                                                                      
    renketsu      num_employee     kessan_month    listed_code   
 Min.   :0.000   Min.   :     0   Min.   : 1.00   Min.   :11.00  
 1st Qu.:1.000   1st Qu.:   795   1st Qu.:12.00   1st Qu.:11.00  
 Median :1.000   Median :  1614   Median :12.00   Median :11.00  
 Mean   :1.083   Mean   :  7229   Mean   :11.98   Mean   :11.28  
 3rd Qu.:1.000   3rd Qu.:  4689   3rd Qu.:12.00   3rd Qu.:12.00  
 Max.   :3.000   Max.   :384586   Max.   :16.00   Max.   :13.00  
                 NA's   :4                                       
 industry_code     total_asset          tangibles            salary       
 Min.   :101001   Min.   :       71   Min.   :       1   Min.   :      1  
 1st Qu.:121204   1st Qu.:    27800   1st Qu.:    5695   1st Qu.:   1719  
 Median :241402   Median :    67269   Median :   16666   Median :   3948  
 Mean   :188818   Mean   :   576964   Mean   :  133755   Mean   :  15426  
 3rd Qu.:257561   3rd Qu.:   206024   3rd Qu.:   57395   3rd Qu.:  11074  
 Max.   :271704   Max.   :303846980   Max.   :13032389   Max.   :1316554  
                  NA's   :3           NA's   :18         NA's   :862      
    rent_fee      corporate_tax     tax_adjustment         net_income      
 Min.   :     1   Min.   :-853182   Min.   :-1120216.0   Min.   :-2008074  
 1st Qu.:   318   1st Qu.:    376   1st Qu.:    -154.0   1st Qu.:     560  
 Median :  1058   Median :   1135   Median :      -5.0   Median :    1984  
 Mean   :  5787   Mean   :   6800   Mean   :     -37.7   Mean   :   13123  
 3rd Qu.:  4270   3rd Qu.:   3657   3rd Qu.:     146.0   3rd Qu.:    6853  
 Max.   :444569   Max.   :1303168   Max.   : 1097414.0   Max.   : 4987962  
 NA's   :18853    NA's   :25        NA's   :420          NA's   :6         
 interest_expense     sales         
 Min.   :    -6   Min.   :       3  
 1st Qu.:    30   1st Qu.:   27268  
 Median :   112   Median :   67179  
 Mean   :  1563   Mean   :  330903  
 3rd Qu.:   457   3rd Qu.:  206892  
 Max.   :555902   Max.   :37154298  
 NA's   :1989     NA's   :11        </code></pre>
</div>
</div>
<p><code>summary()</code>の出力を見ると，欠損値<code>NA's</code>の個数がわかります。 賃借料<code>rent_fee</code>と支払利息<code>interest_expense</code>に欠損値がたくさんあります。 企業が支払っている賃借料や支払利息が小さく，損益計算書に記載されていないだけなので，ここではゼロを代入するようにします。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>df<span class="sc">$</span>rent_fee[<span class="fu">is.na</span>(df<span class="sc">$</span>rent_fee)] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>df<span class="sc">$</span>interest_expense[<span class="fu">is.na</span>(df<span class="sc">$</span>interest_expense)] <span class="ot">&lt;-</span> <span class="dv">0</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>それ以外にも欠損値をもつ項目はありますが，売上高や当期純利益が欠損値となっているのは異常なので，そういった行は除外します。</p>
<p>次にデータの構造を<code>glimpse()</code>関数で確認します。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 27,174
Columns: 18
$ nikkei_code      &lt;chr&gt; "0000001", "0000001", "0000001", "0000001", "0000001"…
$ name             &lt;chr&gt; "極洋", "極洋", "極洋", "極洋", "極洋", "極洋", "極洋…
$ date             &lt;chr&gt; "2010/03", "2011/03", "2012/03", "2013/03", "2014/03"…
$ kessan           &lt;dbl&gt; 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 1…
$ renketsu         &lt;dbl&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,…
$ num_employee     &lt;dbl&gt; 2909, 2753, 2460, 2397, 2111, 2169, 2249, 2193, 2257,…
$ kessan_month     &lt;dbl&gt; 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 1…
$ listed_code      &lt;dbl&gt; 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 1…
$ industry_code    &lt;dbl&gt; 235341, 235341, 235341, 235341, 235341, 235341, 23534…
$ total_asset      &lt;dbl&gt; 64301, 76925, 84937, 83245, 84319, 88937, 94608, 9739…
$ tangibles        &lt;dbl&gt; 11568, 12331, 11574, 11281, 10597, 12241, 16972, 1713…
$ salary           &lt;dbl&gt; 3955, 4261, 4476, 4571, 4466, 4628, 4704, 4926, 5089,…
$ rent_fee         &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2508, 2669,…
$ corporate_tax    &lt;dbl&gt; 923, 799, 1383, 1139, 1255, 2389, 804, 1518, 1416, 12…
$ tax_adjustment   &lt;dbl&gt; -281, -396, -62, -441, 284, 1216, -235, 58, -58, 251,…
$ net_income       &lt;dbl&gt; 1086, 58, 423, 1269, 2968, 2433, 1799, 2422, 3211, 29…
$ interest_expense &lt;dbl&gt; 364, 380, 419, 376, 385, 408, 437, 418, 433, 443, 446…
$ sales            &lt;dbl&gt; 145778, 162731, 181885, 178046, 202387, 218350, 22662…</code></pre>
</div>
</div>
<p>日経コード<code>nikkei_code</code>と企業名称<code>name</code>、決算期<code>date</code>の３つは文字列<code>&lt;chr&gt;</code>で、それ以外の変数は数値<code>&lt;dbl&gt;</code>となっています。 しかし、実際は、<code>kessan</code>、<code>renketsu</code>、<code>listed_code</code>、<code>industry_code</code>はカテゴリカルデータであるため、<code>factor</code>型に変換します。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> df <span class="sc">|&gt;</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">kessan =</span> <span class="fu">as.factor</span>(kessan),</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">renketsu =</span> <span class="fu">as.factor</span>(renketsu),</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">listed_code =</span> <span class="fu">as.factor</span>(listed_code),</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">industry_code =</span> <span class="fu">as.factor</span>(industry_code) <span class="co"># ファクター</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>また財務比率は<strong>分数</strong>で計算されるため、分母がゼロあるいはゼロに近い値をもつと、計算ができなかったり、異常に大きい値が出てきたりします。 そのため、分母となる変数にゼロが含まないようにし、また異常値を除外します。 実証研究では、連続変数に対して上下1%以上の異常値を除外することが多いです。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> df <span class="sc">|&gt;</span> <span class="co"># 売上高、有形固定資産、従業員数が0の企業を除外</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(sales <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">&amp;</span> tangibles <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">&amp;</span> num_employee <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="sc">|&gt;</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">drop_na</span>() <span class="co"># それ以外の欠損値をもつ行を削除</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>最後にデータを確認してみます。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> nikkei_code            name               date           kessan     renketsu 
 Length:25895       Length:25895       Length:25895       10:25895   0:  986  
 Class :character   Class :character   Class :character              1:23815  
 Mode  :character   Mode  :character   Mode  :character              2:   39  
                                                                     3: 1055  
                                                                              
                                                                              
                                                                              
  num_employee     kessan_month   listed_code industry_code  
 Min.   :    12   Min.   : 3.00   11:18782    271704 : 5017  
 1st Qu.:   792   1st Qu.:12.00   12: 6851    245444 : 1375  
 Median :  1566   Median :12.00   13:  262    121210 :  870  
 Mean   :  5602   Mean   :11.98               127262 :  668  
 3rd Qu.:  4358   3rd Qu.:12.00               123225 :  666  
 Max.   :289191   Max.   :16.00               107071 :  612  
                                              (Other):16687  
  total_asset         tangibles           salary           rent_fee       
 Min.   :     231   Min.   :      1   Min.   :      1   Min.   :     0.0  
 1st Qu.:   27830   1st Qu.:   5706   1st Qu.:   1754   1st Qu.:     0.0  
 Median :   65214   Median :  16148   Median :   4012   Median :     0.0  
 Mean   :  341095   Mean   :  97151   Mean   :  15602   Mean   :  1825.2  
 3rd Qu.:  187788   3rd Qu.:  51560   3rd Qu.:  11214   3rd Qu.:   251.5  
 Max.   :82187392   Max.   :7214561   Max.   :1316554   Max.   :444569.0  
                                                                          
 corporate_tax     tax_adjustment         net_income       interest_expense  
 Min.   :-139945   Min.   :-206722.00   Min.   :-2008074   Min.   :    -6.0  
 1st Qu.:    381   1st Qu.:   -145.00   1st Qu.:     569   1st Qu.:    19.0  
 Median :   1107   Median :     -5.00   Median :    1945   Median :    89.0  
 Mean   :   5022   Mean   :    -46.04   Mean   :    9414   Mean   :   988.9  
 3rd Qu.:   3380   3rd Qu.:    139.00   3rd Qu.:    6386   3rd Qu.:   359.0  
 Max.   : 970546   Max.   : 115523.00   Max.   : 1180694   Max.   :117310.0  
                                                                             
     sales         
 Min.   :     228  
 1st Qu.:   27361  
 Median :   64862  
 Mean   :  253626  
 3rd Qu.:  189714  
 Max.   :21571973  
                   </code></pre>
</div>
</div>
<p>これで前処理が終わったので，次は生産性の分析に移っていきます。</p>
</section>
<section id="生産性の分析" class="level2">
<h2 class="anchored" data-anchor-id="生産性の分析">生産性の分析</h2>
<section id="付加価値とその測定" class="level3">
<h3 class="anchored" data-anchor-id="付加価値とその測定">付加価値とその測定</h3>
<p><strong>付加価値</strong>(added value)とは，企業が新たに生み出した価値であり，<strong>生産性</strong>(productivity)とは付加価値を生み出す能力をいいます。 付加価値は，企業の生産性を測る指標として用いられます。</p>
</section>
<section id="付加価値の測定" class="level3">
<h3 class="anchored" data-anchor-id="付加価値の測定">付加価値の測定</h3>
<p>付加価値の測定方法には大きく，控除法と<strong>加算法</strong>の2つがあります。</p>
<p>控除法は，売上高から企業が消費した価値の額を引いたものです。 売上高は把握できますが，消費額は外部からは把握できないため，付加価値の測定が難しいです。</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
控除法
</div>
</div>
<div class="callout-body-container callout-body">
<p><span class="math display">\[
付加価値 = 売上高 - 前段階の企業が生産した価値の消費額
\]</span></p>
</div>
</div>
<p>そのため，よく利用されるのが加算法です。 企業がつくり出した付加価値は， 従業員に分配した人件費と，借主に支払った賃借料，国・地方自治体に支払った税金，債権者に支払った負債利子の合計に， 企業の当期純利益を加えたものとして，計算されます。</p>
<div class="margin-note">
<p>税金は連結損益計算書の法人税等から法人税調整額を加減したものとして計算します。</p>
</div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
加算法
</div>
</div>
<div class="callout-body-container callout-body">
<p><span class="math display">\[
付加価値 = 人件費 + 賃借料 + 税金 + 負債利子 + 当期純利益
\]</span></p>
</div>
</div>
<p>データの入手可能性から，加算法がよく利用されますが，人件費の特定が困難です。 資格試験では従業員数や給与の情報が与えられるので，そこから計算しますが，ここでは連結損益計算書の販売費及び一般管理費の内訳項目である「人件費・福利厚生費」を人件費として扱います。 <code>dplyr</code>パッケージの<code>mutate()</code>関数で付加価値の変数<code>added_value</code>を計算します。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> df <span class="sc">|&gt;</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">added_value =</span> salary <span class="sc">+</span> rent_fee <span class="sc">+</span> (corporate_tax <span class="sc">+</span> tax_adjustment) <span class="sc">+</span> interest_expense <span class="sc">+</span> net_income</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(df<span class="sc">$</span>added_value)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    Min.  1st Qu.   Median     Mean  3rd Qu.     Max. 
-1966993     3406     8211    32806    23898  2321237 </code></pre>
</div>
</div>
<p>付加価値を計算することできたので，付加価値を使った財務分析を行ってみます。</p>
</section>
<section id="労働生産性の分析" class="level3">
<h3 class="anchored" data-anchor-id="労働生産性の分析">労働生産性の分析</h3>
<p><strong>労働生産性</strong>(labor productivity)とは，一定期間における付加価値を(平均)従業員数で割ったものです。 つまり，従業員一人が1年間に生み出した付加価値の額を示しています。</p>
<p><span class="math display">\[
労働生産性_t = \frac{付加価値_t}{平均従業員数_t}
\]</span></p>
<p>分子が付加価値というフロー情報であることから，分母の従業員数も期首と期末の平均をとることで対応させています。 では，計算してみましょう。 期首と期末の値を使って平均値を計算するため，<code>group_by()</code>関数と<code>lag()</code>関数を使います。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> df <span class="sc">|&gt;</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(nikkei_code) <span class="sc">|&gt;</span> <span class="co"># 企業ごとに</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">ave_employee =</span> (<span class="fu">lag</span>(num_employee) <span class="sc">+</span> num_employee) <span class="sc">/</span> <span class="dv">2</span>, <span class="co"># 平均従業員数</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">labor_prod =</span> added_value <span class="sc">/</span> ave_employee <span class="co"># 労働生産性</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>新しく作った変数の記述統計量を確認します。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(df<span class="sc">$</span>ave_employee)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   Min. 1st Qu.  Median    Mean 3rd Qu.    Max.    NA's 
     12     794    1576    5596    4367  285347    2026 </code></pre>
</div>
</div>
<p>最も従業員が少ない会社で12名，最大で約28万名と，従業員数のばらつきが大きいことが分かります。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(df<span class="sc">$</span>labor_prod)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   Min. 1st Qu.  Median    Mean 3rd Qu.    Max.    NA's 
-49.957   2.778   5.257   7.262   9.027 453.811    2026 </code></pre>
</div>
</div>
<p>中央値が<span class="math inline">\(5.257\)</span>で平均値が<span class="math inline">\(7.262\)</span>と中央値の</p>
<p>ヒストグラムも作成してみます。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df) <span class="sc">+</span> <span class="fu">aes</span>(labor_prod) <span class="sc">+</span> <span class="fu">geom_histogram</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 2026 rows containing non-finite values (`stat_bin()`).</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="chap15_financialAnalysis_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>分布が右に偏っており，大きな値に異常値がありそうです。</p>
</section>
<section id="労働生産性の分解" class="level3">
<h3 class="anchored" data-anchor-id="労働生産性の分解">労働生産性の分解</h3>
<p><strong>売上高</strong>を用いた分解：売上高を挟みこむことで，労働生産性を，<strong>一人当たり売上高</strong>と<strong>付加価値率</strong>に分解できる。</p>
<p><span class="math display">\[
労働生産性 = \frac{付加価値額}{平均従業員数} = \underbrace{\frac{売上高}{平均従業員数}}_{1人当たり売上高} \times \underbrace{\frac{付加価値額}{売上高}}_{付加価値率}
\]</span></p>
<p><strong>有形固定資産</strong>を用いた分解：有形固定資産を挟み込むことで，労働生産性を<strong>労働装備率</strong>と<strong>設備生産性</strong>に分解できる。</p>
<p><span class="math display">\[
労働生産性 =\frac{付加価値額}{平均従業員数} = \underbrace{\frac{平均有形固定資産}{平均従業員数}}_{労働装備率} \times \underbrace{\frac{付加価値額}{平均有形固定資産}}_{設備生産性}
\]</span></p>
</section>
</section>
<section id="付加価値の分配" class="level2">
<h2 class="anchored" data-anchor-id="付加価値の分配">3. 付加価値の分配</h2>
<p>付加価値の分配状況をみる。最も大きい分配先は<strong>人件費</strong>であり，<strong>付加価値に占める人件費の割合</strong>を<strong>労働分配率</strong>という。</p>
<p><span class="math display">\[
一人当たり人件費 = \frac{人件費}{平均従業員数} = \underbrace{\frac{付加価値額}{平均従業員数}}_{労働生産性} \times \underbrace{\frac{人件費}{付加価値額}}_{労働分配率}
\]</span></p>
<p>一人当たり人件費は，労働生産性と労働分配率に分類できる。</p>
<section id="定義を覚える" class="level3">
<h3 class="anchored" data-anchor-id="定義を覚える">定義を覚える。</h3>
<ul>
<li><span class="math inline">\(付加価値 = 人件費 + 賃借料 + 税金 + 負債利子 + 当期純利益\)</span></li>
<li><span class="math inline">\(労働生産性 = 付加価値額 \div 平均従業員数\)</span></li>
<li><span class="math inline">\(付加価値率 = 付加価値額 \div 売上高\)</span></li>
<li><span class="math inline">\(労働装備率 = 平均有形固定資産 \div 平均従業員数\)</span></li>
<li><span class="math inline">\(設備生産性 = 付加価値額 \div 平均有形固定資産\)</span></li>
<li><span class="math inline">\(労働分配率 = 人件費 \div 付加価値額\)</span></li>
</ul>
</section>
<section id="関係を覚える" class="level3">
<h3 class="anchored" data-anchor-id="関係を覚える">関係を覚える</h3>
<ul>
<li><span class="math inline">\(労働生産性 = 一人当たり売上高 \times 付加価値率\)</span></li>
<li><span class="math inline">\(労働生産性 = 労働装備率 \times 設備生産性\)</span></li>
<li><span class="math inline">\(一人当たり人件費 =労働生産性 \times 労働分配率\)</span></li>
</ul>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      return note.innerHTML;
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>