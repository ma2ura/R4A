<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.529">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Quantile regression tutorial in R</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="quantile_regression_files/libs/clipboard/clipboard.min.js"></script>
<script src="quantile_regression_files/libs/quarto-html/quarto.js"></script>
<script src="quantile_regression_files/libs/quarto-html/popper.min.js"></script>
<script src="quantile_regression_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="quantile_regression_files/libs/quarto-html/anchor.min.js"></script>
<link href="quantile_regression_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="quantile_regression_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="quantile_regression_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="quantile_regression_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="quantile_regression_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script src="quantile_regression_files/libs/htmlwidgets-1.6.4/htmlwidgets.js"></script>
<script src="quantile_regression_files/libs/plotly-binding-4.10.4/plotly.js"></script>
<script src="quantile_regression_files/libs/typedarray-0.1/typedarray.min.js"></script>
<script src="quantile_regression_files/libs/jquery-3.5.1/jquery.min.js"></script>
<link href="quantile_regression_files/libs/crosstalk-1.2.1/css/crosstalk.min.css" rel="stylesheet">
<script src="quantile_regression_files/libs/crosstalk-1.2.1/js/crosstalk.min.js"></script>
<link href="quantile_regression_files/libs/plotly-htmlwidgets-css-2.11.1/plotly-htmlwidgets.css" rel="stylesheet">
<script src="quantile_regression_files/libs/plotly-main-2.11.1/plotly-latest.min.js"></script>


</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Quantile regression tutorial in R</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="what-is-quantile-regression" class="level2">
<h2 class="anchored" data-anchor-id="what-is-quantile-regression">What is quantile regression?</h2>
<p>Quantile regression is a statistical technique used to model the relationship between a response variable and one or more predictor variables. Unlike traditional regression models that estimate the mean of the response variable given the predictor variables, quantile regression estimates the conditional quantiles of the response variable.</p>
<p>An equal probability portion of a distribution is represented by a quantile. When the median is the 50th percentile, for instance, 50% of the distribution’s values fall below the median and 50% fall above it. We can estimate any conditional quantile of the response variable in quantile regression, not only the median.</p>
<p>Quantile regression’s primary benefit is that it enables us to model the relationship between the predictor variables across different parts of the distribution of the response variable. This can be useful when the relationship between the predictor variables and the response variable is not constant across the distribution, for example, when the relationship is stronger in the tails of the distribution.</p>
<p>Quantile regression can be a good choice if the data violate some of the key assumptions in ordinary least square regression (OLS): domesticity and normality. It is also robust to outliers or influential data points.</p>
<p>Without spending more time, I will proceed directly to the codes. I need few libraries and I will use the life_expectancy data set. I will use quantreg package to do the models(life expactancy as a function of income) and plotly to visualize the coefficients in 3D.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(pacman)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">p_load</span>(dplyr,janitor, ggplot2, quantreg, sjPlot, plotly)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="read-datasets" class="level2">
<h2 class="anchored" data-anchor-id="read-datasets">Read Datasets</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>life_exp  <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"data/life_expectancy.csv"</span>, <span class="at">na.strings =</span> <span class="st">""</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(life_exp)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      Country Year     Status Life.expectancy Adult.Mortality infant.deaths
1 Afghanistan 2015 Developing            65.0             263            62
2 Afghanistan 2014 Developing            59.9             271            64
3 Afghanistan 2013 Developing            59.9             268            66
4 Afghanistan 2012 Developing            59.5             272            69
5 Afghanistan 2011 Developing            59.2             275            71
6 Afghanistan 2010 Developing            58.8             279            74
  Alcohol percentage.expenditure Hepatitis.B Measles  BMI under.five.deaths
1    0.01              71.279624          65    1154 19.1                83
2    0.01              73.523582          62     492 18.6                86
3    0.01              73.219243          64     430 18.1                89
4    0.01              78.184215          67    2787 17.6                93
5    0.01               7.097109          68    3013 17.2                97
6    0.01              79.679367          66    1989 16.7               102
  Polio Total.expenditure Diphtheria HIV.AIDS       GDP Population
1     6              8.16         65      0.1 584.25921   33736494
2    58              8.18         62      0.1 612.69651     327582
3    62              8.13         64      0.1 631.74498   31731688
4    67              8.52         67      0.1 669.95900    3696958
5    68              7.87         68      0.1  63.53723    2978599
6    66              9.20         66      0.1 553.32894    2883167
  thinness..1.19.years thinness.5.9.years Income.composition.of.resources
1                 17.2               17.3                           0.479
2                 17.5               17.5                           0.476
3                 17.7               17.7                           0.470
4                 17.9               18.0                           0.463
5                 18.2               18.2                           0.454
6                 18.4               18.4                           0.448
  Schooling
1      10.1
2      10.0
3       9.9
4       9.8
5       9.5
6       9.2</code></pre>
</div>
</div>
<p>I will now do some data cleaning. The variable names are a bit tedious and to avoid using the backticks. I will simply clean up the column names using the <code>janitor</code> packages very useful <code>clean_names()</code> function</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>life_expe_data  <span class="ot">&lt;-</span> <span class="fu">clean_names</span>(life_exp)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(life_expe_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "country"                         "year"                           
 [3] "status"                          "life_expectancy"                
 [5] "adult_mortality"                 "infant_deaths"                  
 [7] "alcohol"                         "percentage_expenditure"         
 [9] "hepatitis_b"                     "measles"                        
[11] "bmi"                             "under_five_deaths"              
[13] "polio"                           "total_expenditure"              
[15] "diphtheria"                      "hiv_aids"                       
[17] "gdp"                             "population"                     
[19] "thinness_1_19_years"             "thinness_5_9_years"             
[21] "income_composition_of_resources" "schooling"                      </code></pre>
</div>
</div>
<p>Now the variable names are clean, we can do the rest of the coding as follows. I now remove the missing values. You can do better for your data by using imputation techniques to deal with missing values. But that is not my goal here today. Perhaps, I may do a blog or a YouTube video in the future. I just need you to demand for it or encourage me to do it.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>life_exp_narm  <span class="ot">&lt;-</span> life_expe_data[<span class="fu">complete.cases</span>(life_expe_data),]</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(life_exp_narm)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1649   22</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co">#let's remove all with income index around 0.</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>life_exp_narm <span class="ot">&lt;-</span> life_exp_narm <span class="sc">|&gt;</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(income_composition_of_resources <span class="sc">&gt;</span> <span class="dv">0</span>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We have about 22 variables and 1649 observations. Not bad for modelling! Since,<code>income_composition_of_resources</code> is a really long and boring variable name, I am changing it.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(life_exp_narm)[<span class="fu">names</span>(life_exp_narm) <span class="sc">==</span> <span class="st">"income_composition_of_resources"</span>] <span class="ot">&lt;-</span> <span class="st">"income_index"</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(life_exp_narm<span class="sc">$</span>income_index)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
 0.2790  0.5290  0.6770  0.6505  0.7540  0.9360 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sd</span>(life_exp_narm<span class="sc">$</span>income_index)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.1490056</code></pre>
</div>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(life_exp_narm<span class="sc">$</span>life_expectancy)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
  44.00   64.60   71.80   69.39   75.00   89.00 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sd</span>(life_exp_narm<span class="sc">$</span>life_expectancy)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 8.876531</code></pre>
</div>
</div>
<p>You can see that our main predictor variable has a mean 0.65 and SD of 0.149. It maybe a good idea to take a look at it by visualizing it. And the mean life expectancy was 69.4(SD=8.88)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(life_exp_narm) <span class="sc">+</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">x =</span> income_index, <span class="at">y =</span> life_expectancy, <span class="at">col =</span> status) <span class="sc">+</span> </span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>() <span class="sc">+</span> <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">col=</span><span class="st">"blue"</span>) <span class="sc">+</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">xlab</span>(<span class="st">"Income index"</span>) <span class="sc">+</span> <span class="fu">ylab</span>(<span class="st">"Life expectancy"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`geom_smooth()` using formula = 'y ~ x'</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="quantile_regression_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="qauntile-regression" class="level2">
<h2 class="anchored" data-anchor-id="qauntile-regression">Qauntile regression</h2>
<p>Before doing the quantile regression. It might be a good idea to take a look at the visualization by setting different tau values in abline of the base r plot showing the relationship between <code>life_expectancy</code> and <code>income_index</code>. The OLS regression is do the regression from the mean while the quantil regression n quantile regression, we can estimate any conditional quantile of the response variable, not just the mean but could be the medeian (50%), 90%, 75% or anywhere until 99%.If this is not clear, I highly recommended watching the video I dropped earlier. Let’s now visualize the mean and the median ablines</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(life_expectancy  <span class="sc">~</span> income_index, <span class="at">data =</span> life_exp_narm) </span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="fu">lm</span>(life_expectancy  <span class="sc">~</span> income_index, <span class="at">data =</span> life_exp_narm), <span class="at">col=</span><span class="st">"blue"</span>, <span class="at">lwd =</span> <span class="dv">3</span>)</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="fu">rq</span>(life_expectancy  <span class="sc">~</span> income_index, <span class="at">tau=</span><span class="fl">0.5</span>, <span class="at">data =</span> life_exp_narm), <span class="at">col=</span><span class="st">"red"</span>,  <span class="at">lwd =</span> <span class="dv">4</span>) <span class="co"># Notcie the tau=0.5,</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="quantile_regression_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>You can see the plot blue line is the OLS regression line but the red line is if we model the regression using the median. If you have to run only two models and choose the model that best fits the data, you have to choose by AIC or using loss function(eg. the model with minimum mean squared error or mean absolute error, etc will be the best fit). NB: choosing the right model is not my goal here.</p>
<p>Now let’s add 10th and 90th percentiles from the above vizualization and evaluate which line looks better fit for the relationship between the two variables.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(life_expectancy  <span class="sc">~</span> income_index, <span class="at">data =</span> life_exp_narm) </span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="fu">lm</span>(life_expectancy  <span class="sc">~</span> income_index, <span class="at">data =</span> life_exp_narm), <span class="at">col=</span><span class="st">"blue"</span>, <span class="at">lwd =</span> <span class="dv">3</span>)</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="fu">rq</span>(life_expectancy  <span class="sc">~</span> income_index, <span class="at">tau=</span><span class="fl">0.5</span>, <span class="at">data =</span> life_exp_narm), <span class="at">col=</span><span class="st">"red"</span>,  <span class="at">lwd =</span> <span class="dv">4</span>)</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="fu">rq</span>(life_expectancy  <span class="sc">~</span> income_index, <span class="at">tau=</span><span class="fl">0.1</span>, <span class="at">data =</span> life_exp_narm), <span class="at">col=</span><span class="st">"black"</span>,  <span class="at">lwd =</span> <span class="dv">5</span>)</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="fu">rq</span>(life_expectancy  <span class="sc">~</span> income_index, <span class="at">tau=</span><span class="fl">0.90</span>, <span class="at">data =</span> life_exp_narm), <span class="at">col=</span><span class="st">"turquoise4"</span>,  <span class="at">lwd =</span> <span class="dv">6</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="quantile_regression_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We can actually visualize multiple quantreg models and see it compared to the OLS model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(life_exp_narm, <span class="fu">aes</span>(income_index, life_expectancy))<span class="sc">+</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>() <span class="sc">+</span> <span class="co"># scatter plot</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_smooth</span>(<span class="at">method =</span> lm, <span class="at">se =</span> F, <span class="at">color =</span> <span class="st">"darkturquoise"</span>) <span class="sc">+</span> <span class="co"># linear model</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_quantile</span>(<span class="at">color =</span> <span class="st">"red"</span>, <span class="at">quantiles =</span> <span class="fl">0.5</span>) <span class="sc">+</span> <span class="co"># Quantreg based on median</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_quantile</span>(<span class="at">color =</span> <span class="st">"black"</span>, <span class="at">alpha =</span> <span class="fl">0.2</span>, </span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>        <span class="at">quantiles =</span> <span class="fu">seq</span>(.<span class="dv">05</span>, .<span class="dv">95</span>, <span class="at">by =</span> <span class="fl">0.05</span>)) <span class="co">#multiple models from the 5th percentile to 95th percentile</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`geom_smooth()` using formula = 'y ~ x'
Smoothing formula not specified. Using: y ~ x
Smoothing formula not specified. Using: y ~ x</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="quantile_regression_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Let’s now run four different models at the mean(OLS), and quantile regressions at the median, 10th percentile and 95th percentiles. Notice the tau values. I also added one more variable.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>ols <span class="ot">&lt;-</span>  <span class="fu">rq</span>(life_expectancy<span class="sc">~</span>income_index<span class="sc">+</span>schooling, <span class="at">data =</span> life_exp_narm) <span class="co">#Similar to lm()</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>quant_reg_med  <span class="ot">&lt;-</span> <span class="fu">rq</span>(life_expectancy<span class="sc">~</span>income_index<span class="sc">+</span>schooling,<span class="at">tau =</span> <span class="fl">0.5</span>, <span class="at">data =</span> life_exp_narm)</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>quant_reg_first  <span class="ot">&lt;-</span> <span class="fu">rq</span>(life_expectancy<span class="sc">~</span>income_index<span class="sc">+</span>schooling,<span class="at">tau =</span> <span class="fl">0.1</span>, <span class="at">data =</span> life_exp_narm)</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>quant_reg_last  <span class="ot">&lt;-</span> <span class="fu">rq</span>(life_expectancy<span class="sc">~</span>income_index<span class="sc">+</span>schooling,<span class="at">tau =</span> <span class="fl">0.95</span>, <span class="at">data =</span> life_exp_narm)</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(ols)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call: rq(formula = life_expectancy ~ income_index + schooling, data = life_exp_narm)

tau: [1] 0.5

Coefficients:
             Value    Std. Error t value  Pr(&gt;|t|)
(Intercept)  38.59204  0.56239   68.62125  0.00000
income_index 62.04691  1.98135   31.31544  0.00000
schooling    -0.75195  0.10388   -7.23903  0.00000</code></pre>
</div>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(quant_reg_med)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call: rq(formula = life_expectancy ~ income_index + schooling, tau = 0.5, 
    data = life_exp_narm)

tau: [1] 0.5

Coefficients:
             Value    Std. Error t value  Pr(&gt;|t|)
(Intercept)  38.59204  0.56239   68.62125  0.00000
income_index 62.04691  1.98135   31.31544  0.00000
schooling    -0.75195  0.10388   -7.23903  0.00000</code></pre>
</div>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(quant_reg_first)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call: rq(formula = life_expectancy ~ income_index + schooling, tau = 0.1, 
    data = life_exp_narm)

tau: [1] 0.1

Coefficients:
             Value    Std. Error t value  Pr(&gt;|t|)
(Intercept)  25.92063  1.81747   14.26195  0.00000
income_index 84.00142  5.34145   15.72633  0.00000
schooling    -1.34938  0.22578   -5.97661  0.00000</code></pre>
</div>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(quant_reg_last)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in summary.rq(quant_reg_last): 113 non-positive fis</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call: rq(formula = life_expectancy ~ income_index + schooling, tau = 0.95, 
    data = life_exp_narm)

tau: [1] 0.95

Coefficients:
             Value     Std. Error t value   Pr(&gt;|t|) 
(Intercept)   46.56308   0.40214  115.78932   0.00000
income_index  57.37912   2.25777   25.41402   0.00000
schooling     -0.69824   0.10643   -6.56032   0.00000</code></pre>
</div>
</div>
<p>Let’s have a closer look of the median model relative to the lm.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot data points and regression models</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(life_exp_narm, <span class="fu">aes</span>(income_index, life_expectancy)) <span class="sc">+</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> lm, <span class="at">se =</span> <span class="cn">FALSE</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">size =</span> <span class="fl">0.5</span>) <span class="sc">+</span> <span class="co"># linear model</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_quantile</span>(<span class="at">color =</span> <span class="st">"darkturquoise"</span>, <span class="at">quantiles =</span> <span class="fl">0.5</span>, <span class="at">size=</span><span class="dv">2</span>) <span class="sc">+</span> <span class="co"># median quantile regression model with tau = 0.5</span></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_quantile</span>(<span class="at">color =</span> <span class="st">"black"</span>, <span class="at">quantiles =</span> <span class="fl">0.1</span>, <span class="at">size=</span><span class="fl">0.5</span>) <span class="sc">+</span> <span class="co">#quantreg based on the 10th percentile</span></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_quantile</span>(<span class="at">color =</span> <span class="st">"yellow"</span>, <span class="at">quantiles =</span> <span class="fl">0.75</span>, <span class="at">size=</span> <span class="fl">0.5</span>) <span class="sc">+</span> <span class="co">#quantreg based on the 10th percentile</span></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_segment</span>(<span class="fu">aes</span>(<span class="at">x =</span> income_index, <span class="at">y =</span> life_expectancy, <span class="at">xend =</span> income_index, <span class="at">yend =</span> <span class="fu">predict</span>(quant_reg_med, <span class="at">newdata =</span> life_exp_narm)), </span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>               <span class="at">color =</span> <span class="st">"darkgray"</span>, <span class="at">size =</span> <span class="fl">0.1</span>) <span class="sc">+</span> <span class="co"># distance line based on median quantile regression model</span></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">" Life Expectancy~Income Index"</span>, <span class="at">y =</span> <span class="st">"Life Expectancy"</span>, <span class="at">x =</span> <span class="st">"Income Index"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Using `size` aesthetic for lines was deprecated in ggplot2 3.4.0.
ℹ Please use `linewidth` instead.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>`geom_smooth()` using formula = 'y ~ x'
Smoothing formula not specified. Using: y ~ x
Smoothing formula not specified. Using: y ~ x
Smoothing formula not specified. Using: y ~ x</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="quantile_regression_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We can plot the coefficients of the four different models we modeled earlier and compare them.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_models</span>(ols, quant_reg_med, quant_reg_first, quant_reg_last,</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>           <span class="at">show.values =</span> <span class="cn">TRUE</span>,</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>           <span class="at">m.labels =</span> <span class="fu">c</span>(<span class="st">"OLS"</span>, <span class="st">"Median"</span>, <span class="st">"10th percentile"</span>,</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>                       <span class="st">"95th percentile"</span>,</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>                       <span class="at">legend.title =</span> <span class="st">"Model"</span>)</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>           )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in summary.rq(x): 113 non-positive fis</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="quantile_regression_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>You can see the OLS(based one mean) and quanitile regression based on the median are identical.But the one with 10th percentile and 95th percentile are different from the coefficients of the OLS.</p>
<p>For effectively modeling numerous quantreg models, you may do somthing like the following.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>taus<span class="ot">&lt;-</span><span class="fu">seq</span>(<span class="at">from =</span> .<span class="dv">05</span>, <span class="at">to =</span> .<span class="dv">95</span>, <span class="at">by =</span> <span class="fl">0.05</span>) <span class="co">#Taus ranging from 0.05 to 0.95 with a step value of 0.05</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>quant_all  <span class="ot">&lt;-</span> <span class="fu">rq</span>(life_expectancy<span class="sc">~</span>income_index,<span class="at">tau =</span> taus, </span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>                 <span class="at">data =</span> life_exp_narm)</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(quant_all) <span class="co">#To access the cntents of our model</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "coefficients"  "x"             "y"             "residuals"    
 [5] "dual"          "fitted.values" "formula"       "terms"        
 [9] "xlevels"       "call"          "tau"           "rho"          
[13] "method"        "model"        </code></pre>
</div>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>quant_all<span class="sc">$</span>tau <span class="co">#To see the taus</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] 0.05 0.10 0.15 0.20 0.25 0.30 0.35 0.40 0.45 0.50 0.55 0.60 0.65 0.70 0.75
[16] 0.80 0.85 0.90 0.95</code></pre>
</div>
</div>
<p>With that we have got several models. But how we access a specific model for example when tau=0.8 or tau=0.1?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(quant_all)[<span class="fu">which</span>(taus <span class="sc">==</span> <span class="fl">0.8</span>)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]

Call: rq(formula = life_expectancy ~ income_index, tau = taus, data = life_exp_narm)

tau: [1] 0.8

Coefficients:
             Value    Std. Error t value  Pr(&gt;|t|)
(Intercept)  44.77157  0.62620   71.49715  0.00000
income_index 42.89216  0.79348   54.05567  0.00000</code></pre>
</div>
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(quant_all)[<span class="fu">which</span>(taus <span class="sc">==</span> <span class="fl">0.1</span>)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]

Call: rq(formula = life_expectancy ~ income_index, tau = taus, data = life_exp_narm)

tau: [1] 0.1

Coefficients:
             Value    Std. Error t value  Pr(&gt;|t|)
(Intercept)  20.52315  1.70906   12.00844  0.00000
income_index 65.74074  2.18924   30.02897  0.00000</code></pre>
</div>
</div>
<p>If we want to compare the AIC values of these models, as usual we can use AIC()</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>aic_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">AIC =</span> <span class="fu">AIC</span>(quant_all), <span class="at">model =</span> <span class="fu">paste</span>(<span class="st">"tau ="</span>,taus))</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(aic_df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        AIC      model
1 10945.777 tau = 0.05
2 10550.411  tau = 0.1
3 10230.887 tau = 0.15
4  9978.270  tau = 0.2
5  9771.004 tau = 0.25
6  9618.262  tau = 0.3</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(aic_df, <span class="fu">aes</span>(<span class="at">x =</span> model, <span class="at">y =</span> AIC)) <span class="sc">+</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">stat =</span> <span class="st">"identity"</span>, <span class="at">fill =</span> <span class="st">"steelblue"</span>) <span class="sc">+</span></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"AIC values for different tau values"</span>,</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Quantile regression models with different Tau values"</span>,</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Akaike Information Criterion"</span>) <span class="sc">+</span></span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">90</span>, <span class="at">hjust =</span> <span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="quantile_regression_files/figure-html/unnamed-chunk-17-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>It seems the model around the median point is better fit. In general, we ought to pick the model with the lowest AIC score. AIC (Akaike Information Criterion) is a metric used to assess a statistical model’s suitability for a particular set of data. It is based on the model’s complexity as well as its goodness of fit. The model is thought to be better the lower the AIC value.</p>
<p>However, it’s crucial to remember that the AIC should not be the only factor considered when choosing a model. When choosing a model, it is important to take into account a number of additional elements, including interpretability, applicability, and theoretical relevance. It’s also possible that none of the models have an AIC that is noticeably superior to the others, in which case other factors might be more crucial in selecting a model.</p>
</section>
<section id="how-about-if-we-want-to-access-the-coefficients" class="level2">
<h2 class="anchored" data-anchor-id="how-about-if-we-want-to-access-the-coefficients">How about if we want to access the coefficients?</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>QR.coef <span class="ot">&lt;-</span> <span class="fu">coef</span>(quant_all)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Or in a more complicated way like the following</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>lprq <span class="ot">&lt;-</span>  <span class="cf">function</span>(x, y, h, <span class="at">m=</span><span class="dv">19</span> , <span class="at">tau=</span>.<span class="dv">5</span>)</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>  {</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>    xx <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="fu">min</span>(x),<span class="fu">max</span>(x),<span class="at">length=</span>m)</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>    fv <span class="ot">&lt;-</span> xx</span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>    dv <span class="ot">&lt;-</span> xx</span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(xx)) {</span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>      z <span class="ot">&lt;-</span> x <span class="sc">-</span> xx[i]</span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a>      wx <span class="ot">&lt;-</span> <span class="fu">dnorm</span>(z<span class="sc">/</span>h)</span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a>      r <span class="ot">&lt;-</span> <span class="fu">rq</span>(y<span class="sc">~</span>z, <span class="at">weights=</span>wx, <span class="at">tau=</span>tau, <span class="at">ci=</span><span class="cn">FALSE</span>)</span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a>      fv[i] <span class="ot">&lt;-</span> r<span class="sc">$</span>coef[<span class="fl">1.</span>] </span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a>      dv[i] <span class="ot">&lt;-</span> r<span class="sc">$</span>coef[<span class="fl">2.</span>]  </span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb49-13"><a href="#cb49-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">data.frame</span>(<span class="at">dv =</span> dv)</span>
<span id="cb49-14"><a href="#cb49-14" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb49-15"><a href="#cb49-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-16"><a href="#cb49-16" aria-hidden="true" tabindex="-1"></a><span class="co">#Create a matrix to save the QQR estimates</span></span>
<span id="cb49-17"><a href="#cb49-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-18"><a href="#cb49-18" aria-hidden="true" tabindex="-1"></a>taus<span class="ot">&lt;-</span><span class="fu">seq</span>(<span class="at">from =</span> .<span class="dv">05</span>, <span class="at">to =</span> .<span class="dv">95</span>, <span class="at">by =</span> <span class="fl">0.05</span>)</span>
<span id="cb49-19"><a href="#cb49-19" aria-hidden="true" tabindex="-1"></a>QQR.coef <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">ncol =</span> <span class="dv">19</span>, <span class="at">nrow =</span> <span class="dv">19</span>))</span>
<span id="cb49-20"><a href="#cb49-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Run QQR in a loop and save estimates in matrix "QQR.coef"</span></span>
<span id="cb49-21"><a href="#cb49-21" aria-hidden="true" tabindex="-1"></a><span class="co">#Note: 0.05 in below loop is the bandwidth that can be adjusted</span></span>
<span id="cb49-22"><a href="#cb49-22" aria-hidden="true" tabindex="-1"></a>o <span class="ot">&lt;-</span>life_exp_narm<span class="sc">$</span>life_expectancy</span>
<span id="cb49-23"><a href="#cb49-23" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span>life_exp_narm<span class="sc">$</span>income_index</span>
<span id="cb49-24"><a href="#cb49-24" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">19</span>){</span>
<span id="cb49-25"><a href="#cb49-25" aria-hidden="true" tabindex="-1"></a>  x<span class="ot">&lt;-</span><span class="fu">lprq</span>(o, p,<span class="fl">0.05</span>,<span class="at">tau=</span>taus[i])</span>
<span id="cb49-26"><a href="#cb49-26" aria-hidden="true" tabindex="-1"></a>  QQR.coef[,i]<span class="ot">&lt;-</span>x</span>
<span id="cb49-27"><a href="#cb49-27" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s now save all coefficients in a matrix</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>beta <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(QQR.coef)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="vizualize" class="level2">
<h2 class="anchored" data-anchor-id="vizualize">Vizualize</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">plot_ly</span>( <span class="at">z =</span> <span class="sc">~</span>beta, <span class="at">x =</span> <span class="sc">~</span>taus, <span class="at">y =</span> <span class="sc">~</span>taus, <span class="at">opacity =</span> <span class="fl">0.6</span>) <span class="sc">%&gt;%</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_markers</span>()</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>p <span class="sc">%&gt;%</span> <span class="fu">add_surface</span>(<span class="at">z =</span> <span class="sc">~</span>beta, <span class="at">x =</span> <span class="sc">~</span>taus, <span class="at">y =</span> <span class="sc">~</span>taus, <span class="at">showscale =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layout</span>(<span class="at">showlegend =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="plotly html-widget html-fill-item" id="htmlwidget-e037283eca155fa1926c" style="width:100%;height:464px;"></div>
<script type="application/json" data-for="htmlwidget-e037283eca155fa1926c">{"x":{"visdat":{"5995646d6f42":["function () ","plotlyVisDat"]},"cur_data":"5995646d6f42","attrs":{"5995646d6f42":{"z":{},"x":{},"y":{},"opacity":0.59999999999999998,"alpha_stroke":1,"sizes":[10,100],"spans":[1,20],"type":"scatter3d","mode":"markers","inherit":true},"5995646d6f42.1":{"z":{},"x":{},"y":{},"opacity":0.59999999999999998,"alpha_stroke":1,"sizes":[10,100],"spans":[1,20],"type":"surface","showscale":false,"inherit":true}},"layout":{"margin":{"b":40,"l":60,"t":25,"r":10},"showlegend":false,"scene":{"xaxis":{"title":"taus"},"yaxis":{"title":"taus"},"zaxis":{"title":"beta"}},"hovermode":"closest"},"source":"A","config":{"modeBarButtonsToAdd":["hoverclosest","hovercompare"],"showSendToCloud":false},"data":[{"z":[[0.063333333333333838,0.063333333333333838,0.063333333333333838,0.063333333333333838,0.063333333333333838,0.063333333333333838,0.063333333333333838,0.063333333333333838,0.063333333333333838,0.063333333333333838,0.063333333333333838,0.063333333333333838,0.063333333333333838,0.063333333333333838,0.063333333333333838,0.063333333333333838,0.063333333333333838,0.063333333333333838,0.063333333333333838],[-0.43999999999999406,-0.43999999999999406,-0.43999999999999406,-0.43999999999999406,-0.43999999999999406,-0.43999999999999406,-0.43999999999999373,-0.43999999999999373,-0.43999999999999373,-0.43999999999999373,-0.76499999999998869,-0.76499999999998869,-0.76499999999998869,-0.76499999999998891,-0.76499999999998891,-0.76499999999998891,-0.76499999999998891,-0.76499999999998891,-0.76499999999998891],[0.43999999999999356,0.43999999999999356,0.43999999999999356,0.43999999999999356,0.43999999999999356,0.43999999999999356,0.43999999999999356,0.43999999999999356,0.43999999999999356,0.43999999999999362,0.43999999999999356,0.43999999999999356,0.43999999999999356,0.43999999999999356,0.43999999999999356,0.43999999999999356,0.43999999999999356,0.43999999999999356,0.43999999999999356],[-0.44999999999999329,-0.44999999999999374,-0.44999999999999374,-0.44999999999999374,-0.44999999999999374,-0.44999999999999374,-0.44999999999999374,-0.44999999999999374,-0.44999999999999374,-0.44999999999999374,-0.44999999999999374,-0.44999999999999374,-0.44999999999999374,-0.44999999999999374,-0.44999999999999374,-0.71999999999998976,-0.13499999999999818,-0.13499999999999818,-0.13499999999999812],[-0.41999999999999382,-0.41999999999999382,-0.41999999999999382,-0.41999999999999382,-0.99999999999998623,-0.99999999999998623,0.53999999999999204,0.30999999999999561,0.30999999999999561,0.30999999999999561,0.30999999999999561,-0.41750000000000148,-1.6499999999999768,-1.3499999999999812,-1.3499999999999812,-1.3499999999999812,-1.3899999999999808,-1.3899999999999808,-1.3899999999999808],[0.31999999999999562,0.31999999999999562,0.31999999999999562,0.31999999999999562,0.49999999999999295,0.33999999999999531,0.33999999999999531,0.33999999999999531,0.33999999999999531,0.036666666666666153,0.32999999999999552,0.32999999999999552,0.32999999999999552,0.32999999999999552,0.32999999999999552,1.2099999999999826,1.2099999999999826,1.2099999999999826,1.2099999999999826],[0.039999999999999404,0.039999999999999404,0.039999999999999404,0.039999999999999404,0.11999999999999872,0.11999999999999872,-0.069999999999998591,-0.069999999999998647,-0.20999999999999711,-0.049999999999999448,-0.22499999999999681,-0.1799999999999975,-0.1799999999999975,-0.1799999999999975,-0.1799999999999975,-0.1799999999999975,-0.1799999999999975,-0.17999999999999769,-0.61999999999999134],[0.65999999999999082,0.65999999999999071,0.80499999999998806,0.80499999999998817,0.79999999999998794,0.79999999999998783,0.79999999999998817,0.79999999999998817,0.79999999999998817,0.20999999999999691,0.1399999999999984,0.1399999999999984,0.46999999999999326,0.43999999999999356,0.8499999999999881,0.83499999999998809,0.83499999999998831,0.024999999999999946,0.024999999999999724],[-0.18999999999999687,-0.18999999999999687,-0.18999999999999687,0.0099999999999996741,0.0099999999999999187,0.0099999999999999187,0.0099999999999999187,0.090000000000001745,-0.35000000000002041,-0.35000000000002041,-0.35000000000002041,-0.96500000000002095,-0.66999999999999116,-0.66999999999999116,-0.66999999999999116,-0.66999999999999105,-0.54999999999999272,-0.54999999999999272,-0.54999999999999272],[-0.37000000000002004,-0.37000000000002004,-0.37000000000002004,-0.37000000000002004,-0.37000000000002004,0.015000000000000881,0.015000000000000962,-0.14000000000000801,-0.14000000000000803,-0.11500000000000608,0.035000000000002071,0.03500000000000212,-0.01499999999999959,-0.01499999999999959,-0.01499999999999959,-0.01499999999999959,-0.01499999999999959,-0.01499999999999959,0.020000000000000913],[1.1299999999999839,0.65499999999999059,0.65499999999999059,0.50499999999999257,0.50499999999999257,0.46999999999999337,0.46999999999999337,-0.090000000000005215,-0.080000000000004443,0.090000000000005367,0.090000000000005367,-0.13000000000000772,-0.080000000000005053,-0.08000000000000472,0.28499999999999642,0.28499999999999642,0.11500000000000631,0.11000000000000672,0.010000000000001079],[0.085000000000004863,0.43500000000002481,0.30000000000001764,0.21000000000001198,0.21000000000001198,0.21000000000001254,0.095000000000005441,0.16000000000000955,0.16000000000000955,0.13000000000000694,0.23000000000001281,0.23000000000001269,0.23000000000001269,0.26000000000001278,0.26000000000001328,0.26000000000001328,0.39500000000002239,0.26500000000001545,0.29000000000001719],[0.11000000000000625,0.11000000000000673,0.13000000000000786,0.09000000000000484,0.39000000000002216,0.39000000000002244,0.24000000000001354,0.16000000000000891,0.12000000000000657,0.12000000000000718,0.22500000000001305,0.26000000000001533,0.25000000000001416,0.20000000000001183,0.20000000000001183,0.19000000000001108,0.19000000000001069,0.16000000000000941,0.16000000000000941],[0.10500000000000599,0.050000000000002827,0.040000000000002388,0.040000000000002388,0.040000000000002388,0.040000000000002388,0.070000000000004059,0.13000000000000717,0.13000000000000717,0.13000000000000717,0.13000000000000717,0.13000000000000717,0.15500000000000871,0.035000000000001259,0.14000000000000767,0.14000000000000767,0.14000000000000767,0.14000000000000767,0.16500000000000914],[-1.450000000000083,-1.450000000000083,-0.75000000000004241,-0.75000000000004241,0.18000000000001062,0.18000000000001118,0.18000000000001118,0.16000000000000833,0.1600000000000078,0.11000000000000561,0.10000000000000503,0.10000000000000503,0.12000000000000589,0.12000000000000635,0.12000000000000635,-0.065000000000003749,0.040000000000002346,0.040000000000002284,0.040000000000002284],[0.05500000000000331,-0.080000000000006233,-0.080000000000006233,-0.080000000000006233,-0.080000000000006233,-0.16000000000000911,-0.16000000000000911,-0.16000000000000911,-0.16000000000000911,-0.12000000000000717,-0.070000000000003906,-0.070000000000003906,-0.070000000000003906,-0.070000000000004003,0.040000000000002645,0.040000000000002645,0.040000000000002645,0.040000000000002645,-0.075000000000004091],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]],"x":[0.050000000000000003,0.10000000000000001,0.15000000000000002,0.20000000000000001,0.25,0.29999999999999999,0.35000000000000003,0.40000000000000002,0.45000000000000001,0.5,0.55000000000000004,0.60000000000000009,0.65000000000000013,0.70000000000000007,0.75000000000000011,0.80000000000000004,0.85000000000000009,0.90000000000000013,0.94999999999999996],"y":[0.050000000000000003,0.10000000000000001,0.15000000000000002,0.20000000000000001,0.25,0.29999999999999999,0.35000000000000003,0.40000000000000002,0.45000000000000001,0.5,0.55000000000000004,0.60000000000000009,0.65000000000000013,0.70000000000000007,0.75000000000000011,0.80000000000000004,0.85000000000000009,0.90000000000000013,0.94999999999999996],"opacity":0.59999999999999998,"type":"scatter3d","mode":"markers","marker":{"color":"rgba(31,119,180,1)","line":{"color":"rgba(31,119,180,1)"}},"error_y":{"color":"rgba(31,119,180,1)"},"error_x":{"color":"rgba(31,119,180,1)"},"line":{"color":"rgba(31,119,180,1)"},"frame":null},{"colorbar":{"title":"beta<br />beta","ticklen":2},"colorscale":[["0","rgba(68,1,84,1)"],["0.0416666666666666","rgba(70,19,97,1)"],["0.0833333333333333","rgba(72,32,111,1)"],["0.125","rgba(71,45,122,1)"],["0.166666666666667","rgba(68,58,128,1)"],["0.208333333333333","rgba(64,70,135,1)"],["0.25","rgba(60,82,138,1)"],["0.291666666666667","rgba(56,93,140,1)"],["0.333333333333333","rgba(49,104,142,1)"],["0.375","rgba(46,114,142,1)"],["0.416666666666667","rgba(42,123,142,1)"],["0.458333333333333","rgba(38,133,141,1)"],["0.5","rgba(37,144,140,1)"],["0.541666666666667","rgba(33,154,138,1)"],["0.583333333333333","rgba(39,164,133,1)"],["0.625","rgba(47,174,127,1)"],["0.666666666666667","rgba(53,183,121,1)"],["0.708333333333333","rgba(79,191,110,1)"],["0.75","rgba(98,199,98,1)"],["0.791666666666667","rgba(119,207,85,1)"],["0.833333333333333","rgba(147,214,70,1)"],["0.875","rgba(172,220,52,1)"],["0.916666666666667","rgba(199,225,42,1)"],["0.958333333333333","rgba(226,228,40,1)"],["1","rgba(253,231,37,1)"]],"showscale":false,"z":[[0.063333333333333838,0.063333333333333838,0.063333333333333838,0.063333333333333838,0.063333333333333838,0.063333333333333838,0.063333333333333838,0.063333333333333838,0.063333333333333838,0.063333333333333838,0.063333333333333838,0.063333333333333838,0.063333333333333838,0.063333333333333838,0.063333333333333838,0.063333333333333838,0.063333333333333838,0.063333333333333838,0.063333333333333838],[-0.43999999999999406,-0.43999999999999406,-0.43999999999999406,-0.43999999999999406,-0.43999999999999406,-0.43999999999999406,-0.43999999999999373,-0.43999999999999373,-0.43999999999999373,-0.43999999999999373,-0.76499999999998869,-0.76499999999998869,-0.76499999999998869,-0.76499999999998891,-0.76499999999998891,-0.76499999999998891,-0.76499999999998891,-0.76499999999998891,-0.76499999999998891],[0.43999999999999356,0.43999999999999356,0.43999999999999356,0.43999999999999356,0.43999999999999356,0.43999999999999356,0.43999999999999356,0.43999999999999356,0.43999999999999356,0.43999999999999362,0.43999999999999356,0.43999999999999356,0.43999999999999356,0.43999999999999356,0.43999999999999356,0.43999999999999356,0.43999999999999356,0.43999999999999356,0.43999999999999356],[-0.44999999999999329,-0.44999999999999374,-0.44999999999999374,-0.44999999999999374,-0.44999999999999374,-0.44999999999999374,-0.44999999999999374,-0.44999999999999374,-0.44999999999999374,-0.44999999999999374,-0.44999999999999374,-0.44999999999999374,-0.44999999999999374,-0.44999999999999374,-0.44999999999999374,-0.71999999999998976,-0.13499999999999818,-0.13499999999999818,-0.13499999999999812],[-0.41999999999999382,-0.41999999999999382,-0.41999999999999382,-0.41999999999999382,-0.99999999999998623,-0.99999999999998623,0.53999999999999204,0.30999999999999561,0.30999999999999561,0.30999999999999561,0.30999999999999561,-0.41750000000000148,-1.6499999999999768,-1.3499999999999812,-1.3499999999999812,-1.3499999999999812,-1.3899999999999808,-1.3899999999999808,-1.3899999999999808],[0.31999999999999562,0.31999999999999562,0.31999999999999562,0.31999999999999562,0.49999999999999295,0.33999999999999531,0.33999999999999531,0.33999999999999531,0.33999999999999531,0.036666666666666153,0.32999999999999552,0.32999999999999552,0.32999999999999552,0.32999999999999552,0.32999999999999552,1.2099999999999826,1.2099999999999826,1.2099999999999826,1.2099999999999826],[0.039999999999999404,0.039999999999999404,0.039999999999999404,0.039999999999999404,0.11999999999999872,0.11999999999999872,-0.069999999999998591,-0.069999999999998647,-0.20999999999999711,-0.049999999999999448,-0.22499999999999681,-0.1799999999999975,-0.1799999999999975,-0.1799999999999975,-0.1799999999999975,-0.1799999999999975,-0.1799999999999975,-0.17999999999999769,-0.61999999999999134],[0.65999999999999082,0.65999999999999071,0.80499999999998806,0.80499999999998817,0.79999999999998794,0.79999999999998783,0.79999999999998817,0.79999999999998817,0.79999999999998817,0.20999999999999691,0.1399999999999984,0.1399999999999984,0.46999999999999326,0.43999999999999356,0.8499999999999881,0.83499999999998809,0.83499999999998831,0.024999999999999946,0.024999999999999724],[-0.18999999999999687,-0.18999999999999687,-0.18999999999999687,0.0099999999999996741,0.0099999999999999187,0.0099999999999999187,0.0099999999999999187,0.090000000000001745,-0.35000000000002041,-0.35000000000002041,-0.35000000000002041,-0.96500000000002095,-0.66999999999999116,-0.66999999999999116,-0.66999999999999116,-0.66999999999999105,-0.54999999999999272,-0.54999999999999272,-0.54999999999999272],[-0.37000000000002004,-0.37000000000002004,-0.37000000000002004,-0.37000000000002004,-0.37000000000002004,0.015000000000000881,0.015000000000000962,-0.14000000000000801,-0.14000000000000803,-0.11500000000000608,0.035000000000002071,0.03500000000000212,-0.01499999999999959,-0.01499999999999959,-0.01499999999999959,-0.01499999999999959,-0.01499999999999959,-0.01499999999999959,0.020000000000000913],[1.1299999999999839,0.65499999999999059,0.65499999999999059,0.50499999999999257,0.50499999999999257,0.46999999999999337,0.46999999999999337,-0.090000000000005215,-0.080000000000004443,0.090000000000005367,0.090000000000005367,-0.13000000000000772,-0.080000000000005053,-0.08000000000000472,0.28499999999999642,0.28499999999999642,0.11500000000000631,0.11000000000000672,0.010000000000001079],[0.085000000000004863,0.43500000000002481,0.30000000000001764,0.21000000000001198,0.21000000000001198,0.21000000000001254,0.095000000000005441,0.16000000000000955,0.16000000000000955,0.13000000000000694,0.23000000000001281,0.23000000000001269,0.23000000000001269,0.26000000000001278,0.26000000000001328,0.26000000000001328,0.39500000000002239,0.26500000000001545,0.29000000000001719],[0.11000000000000625,0.11000000000000673,0.13000000000000786,0.09000000000000484,0.39000000000002216,0.39000000000002244,0.24000000000001354,0.16000000000000891,0.12000000000000657,0.12000000000000718,0.22500000000001305,0.26000000000001533,0.25000000000001416,0.20000000000001183,0.20000000000001183,0.19000000000001108,0.19000000000001069,0.16000000000000941,0.16000000000000941],[0.10500000000000599,0.050000000000002827,0.040000000000002388,0.040000000000002388,0.040000000000002388,0.040000000000002388,0.070000000000004059,0.13000000000000717,0.13000000000000717,0.13000000000000717,0.13000000000000717,0.13000000000000717,0.15500000000000871,0.035000000000001259,0.14000000000000767,0.14000000000000767,0.14000000000000767,0.14000000000000767,0.16500000000000914],[-1.450000000000083,-1.450000000000083,-0.75000000000004241,-0.75000000000004241,0.18000000000001062,0.18000000000001118,0.18000000000001118,0.16000000000000833,0.1600000000000078,0.11000000000000561,0.10000000000000503,0.10000000000000503,0.12000000000000589,0.12000000000000635,0.12000000000000635,-0.065000000000003749,0.040000000000002346,0.040000000000002284,0.040000000000002284],[0.05500000000000331,-0.080000000000006233,-0.080000000000006233,-0.080000000000006233,-0.080000000000006233,-0.16000000000000911,-0.16000000000000911,-0.16000000000000911,-0.16000000000000911,-0.12000000000000717,-0.070000000000003906,-0.070000000000003906,-0.070000000000003906,-0.070000000000004003,0.040000000000002645,0.040000000000002645,0.040000000000002645,0.040000000000002645,-0.075000000000004091],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]],"x":[0.050000000000000003,0.10000000000000001,0.15000000000000002,0.20000000000000001,0.25,0.29999999999999999,0.35000000000000003,0.40000000000000002,0.45000000000000001,0.5,0.55000000000000004,0.60000000000000009,0.65000000000000013,0.70000000000000007,0.75000000000000011,0.80000000000000004,0.85000000000000009,0.90000000000000013,0.94999999999999996],"y":[0.050000000000000003,0.10000000000000001,0.15000000000000002,0.20000000000000001,0.25,0.29999999999999999,0.35000000000000003,0.40000000000000002,0.45000000000000001,0.5,0.55000000000000004,0.60000000000000009,0.65000000000000013,0.70000000000000007,0.75000000000000011,0.80000000000000004,0.85000000000000009,0.90000000000000013,0.94999999999999996],"opacity":0.59999999999999998,"type":"surface","frame":null}],"highlight":{"on":"plotly_click","persistent":false,"dynamic":false,"selectize":false,"opacityDim":0.20000000000000001,"selected":{"opacity":1},"debounce":0},"shinyEvents":["plotly_hover","plotly_click","plotly_selected","plotly_relayout","plotly_brushed","plotly_brushing","plotly_clickannotation","plotly_doubleclick","plotly_deselect","plotly_afterplot","plotly_sunburstclick"],"base_url":"https://plot.ly"},"evals":[],"jsHooks":[]}</script>
</div>
</div>
</section>
<section id="quantile-process-plot" class="level2">
<h2 class="anchored" data-anchor-id="quantile-process-plot">Quantile process plot</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(quant_all) <span class="sc">|&gt;</span> <span class="fu">plot</span>(<span class="st">"income_index"</span>) <span class="co">#Let's ignore the intercept</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="quantile_regression_files/figure-html/unnamed-chunk-22-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The <code>summary(quant_all) |&gt; plot(“income_index”)</code> command generates a Quantile Process Plot for the variable income_index. A quantile process plot is a graphical tool to assess the relationship between the response variable (in our case, life_expectancy) and the predictor variable (income_index) across different quantiles of the response distribution. The x-axis represents the predictor variable, and the y-axis represents the quantiles of the response variable. The plot shows a line for each quantile of interest (0.05, 0.1, 0.15, …, 0.95), indicating the estimated relationship between income_index and the corresponding quantile of life_expectancy. The shaded area is for quantile regression and its confidence intervals.The slope of each line represents the estimated effect of income_index on the given quantile of life_expectancy. The solid and dashed red lines show the linear model and its lower and upper bound confidence intervals, respectively. In the plot, we can see only a very small region(from around 0.25 to 0.4) overlaps with the linear model. The large portion of the plot when the income index is larger than 0.4 or when it is lower than 0.2 is not overlapping indicating the difference between the quantreg approach and the OLS modeling approach.</p>
<p>In addition, we can see curvatures or non-linearity in the lines, which may indicate that the relationship between the variables is more complex than a simple linear one. Hence, a more complex model may be necessary to capture the full range of the relationship between the two variables.</p>
<p>That is all for today. Again I highly recommend watching the video and reading quantreg package functions. I hope you like it. See you in the next post.</p>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      return note.innerHTML;
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>