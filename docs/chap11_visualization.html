<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="ja" xml:lang="ja"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.529">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>R for Empirical Accounting Research - 11&nbsp; ggplot2で可視化</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>

<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./chap12_ggpubr.html" rel="next">
<link href="./part03.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "一致なし",
    "search-matching-documents-text": "一致した文書",
    "search-copy-link-title": "検索へのリンクをコピー",
    "search-hide-matches-text": "追加の検索結果を非表示",
    "search-more-match-text": "追加の検索結果",
    "search-more-matches-text": "追加の検索結果",
    "search-clear-button-title": "消去",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "取消",
    "search-submit-button-title": "検索",
    "search-label": "サーチ"
  }
}</script><script>window.backupDefine = window.define; window.define = undefined;</script><script src="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js"></script><script>document.addEventListener("DOMContentLoaded", function () {
 var mathElements = document.getElementsByClassName("math");
 var macros = [];
 for (var i = 0; i < mathElements.length; i++) {
  var texText = mathElements[i].firstChild;
  if (mathElements[i].tagName == "SPAN") {
   katex.render(texText.data, mathElements[i], {
    displayMode: mathElements[i].classList.contains('display'),
    throwOnError: false,
    macros: macros,
    fleqn: false
   });
}}});
  </script><script>window.define = window.backupDefine; window.backupDefine = undefined;</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css">
<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>
</head>
<body class="nav-sidebar floating slimcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav"><div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="サイドバーを切り替える" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./part03.html">第3部 データの可視化</a></li><li class="breadcrumb-item"><a href="./chap11_visualization.html"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">ggplot2で可視化</span></a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="サイドバーを切り替える" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">R for Empirical Accounting Research</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="サーチ"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Rによる実証会計入門</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./part01.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">第1部 R言語の基礎</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="セクションを切り替え">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chap02_prepare.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">準備</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chap03_code.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">コード作成の作法</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chap04_R.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Rの基礎</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chap04_dataframe.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">データフレーム</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chap05_packages.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">パッケージ</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chap06_function.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">関数</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chap07_pipe.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">パイプ演算子</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chap08_tidydata.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">整然データ</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./part02.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">第2部 前処理と記述統計量</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true" aria-label="セクションを切り替え">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chap09_merge.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">データの結合</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chap09_handling.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">データハンドリング</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./part03.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">第3部 データの可視化</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true" aria-label="セクションを切り替え">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chap11_visualization.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">ggplot2で可視化</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chap12_ggpubr.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">ggpubrで可視化</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chap13_gg_function.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">ggplotを関数に埋め込む</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chap14_ggplot_ghibli.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">ggplotとジブリ</span></span></a>
  </div>
</li>
      </ul>
</li>
    </ul>
</div>
</nav><div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">目次</h2>
   
  <ul>
<li><a href="#%E5%8F%AF%E8%A6%96%E5%8C%96%E3%81%AE%E3%83%91%E3%83%83%E3%82%B1%E3%83%BC%E3%82%B8" id="toc-可視化のパッケージ" class="nav-link active" data-scroll-target="#%E5%8F%AF%E8%A6%96%E5%8C%96%E3%81%AE%E3%83%91%E3%83%83%E3%82%B1%E3%83%BC%E3%82%B8"><span class="header-section-number">11.1</span> 可視化のパッケージ</a></li>
  <li>
<a href="#ggplot%E3%83%91%E3%83%83%E3%82%B1%E3%83%BC%E3%82%B8%E3%81%AE%E5%9F%BA%E7%A4%8E" id="toc-ggplotパッケージの基礎" class="nav-link" data-scroll-target="#ggplot%E3%83%91%E3%83%83%E3%82%B1%E3%83%BC%E3%82%B8%E3%81%AE%E5%9F%BA%E7%A4%8E"><span class="header-section-number">11.2</span> ggplotパッケージの基礎</a>
  <ul class="collapse">
<li><a href="#ggplot%E9%96%A2%E6%95%B0%E3%81%AE%E5%9F%BA%E6%9C%AC%E7%9A%84%E3%81%AA%E4%BD%BF%E3%81%84%E6%96%B9%E3%81%A8%E5%A4%89%E6%95%B0%E3%81%AE%E7%89%B9%E5%BE%B4%E6%8A%8A%E6%8F%A1" id="toc-ggplot関数の基本的な使い方と変数の特徴把握" class="nav-link" data-scroll-target="#ggplot%E9%96%A2%E6%95%B0%E3%81%AE%E5%9F%BA%E6%9C%AC%E7%9A%84%E3%81%AA%E4%BD%BF%E3%81%84%E6%96%B9%E3%81%A8%E5%A4%89%E6%95%B0%E3%81%AE%E7%89%B9%E5%BE%B4%E6%8A%8A%E6%8F%A1"><span class="header-section-number">11.2.1</span> <code>ggplot()</code>関数の基本的な使い方と変数の特徴把握</a></li>
  </ul>
</li>
  <li>
<a href="#%E5%A4%89%E6%95%B0%E3%81%AE%E5%8F%AF%E8%A6%96%E5%8C%96" id="toc-変数の可視化" class="nav-link" data-scroll-target="#%E5%A4%89%E6%95%B0%E3%81%AE%E5%8F%AF%E8%A6%96%E5%8C%96"><span class="header-section-number">11.3</span> 1変数の可視化</a>
  <ul class="collapse">
<li><a href="#%E3%83%92%E3%82%B9%E3%83%88%E3%82%B0%E3%83%A9%E3%83%A0" id="toc-ヒストグラム" class="nav-link" data-scroll-target="#%E3%83%92%E3%82%B9%E3%83%88%E3%82%B0%E3%83%A9%E3%83%A0"><span class="header-section-number">11.3.1</span> ヒストグラム</a></li>
  </ul>
</li>
  <li>
<a href="#%E5%A4%89%E6%95%B0%E3%81%AE%E5%8F%AF%E8%A6%96%E5%8C%96-1" id="toc-変数の可視化-1" class="nav-link" data-scroll-target="#%E5%A4%89%E6%95%B0%E3%81%AE%E5%8F%AF%E8%A6%96%E5%8C%96-1"><span class="header-section-number">11.4</span> 2変数の可視化</a>
  <ul class="collapse">
<li><a href="#%E6%A8%AA%E8%BB%B8%E3%81%8C%E9%80%A3%E7%B6%9A%E7%B8%A6%E8%BB%B8%E3%82%82%E9%80%A3%E7%B6%9A%E3%81%AE%E5%A0%B4%E5%90%88" id="toc-横軸が連続縦軸も連続の場合" class="nav-link" data-scroll-target="#%E6%A8%AA%E8%BB%B8%E3%81%8C%E9%80%A3%E7%B6%9A%E7%B8%A6%E8%BB%B8%E3%82%82%E9%80%A3%E7%B6%9A%E3%81%AE%E5%A0%B4%E5%90%88"><span class="header-section-number">11.4.1</span> 横軸が連続・縦軸も連続の場合</a></li>
  <li><a href="#%E6%A8%AA%E8%BB%B8%E3%81%8C%E3%82%AB%E3%83%86%E3%82%B4%E3%83%AA%E3%83%BC%E5%A4%89%E6%95%B0%E7%B8%A6%E8%BB%B8%E3%81%8C%E9%80%A3%E7%B6%9A%E5%A4%89%E6%95%B0%E3%81%AE%E5%A0%B4%E5%90%88" id="toc-横軸がカテゴリー変数縦軸が連続変数の場合" class="nav-link" data-scroll-target="#%E6%A8%AA%E8%BB%B8%E3%81%8C%E3%82%AB%E3%83%86%E3%82%B4%E3%83%AA%E3%83%BC%E5%A4%89%E6%95%B0%E7%B8%A6%E8%BB%B8%E3%81%8C%E9%80%A3%E7%B6%9A%E5%A4%89%E6%95%B0%E3%81%AE%E5%A0%B4%E5%90%88"><span class="header-section-number">11.4.2</span> 横軸がカテゴリー変数・縦軸が連続変数の場合</a></li>
  <li><a href="#%E5%9B%B3%E3%81%AE%E4%BF%9D%E5%AD%98" id="toc-図の保存" class="nav-link" data-scroll-target="#%E5%9B%B3%E3%81%AE%E4%BF%9D%E5%AD%98"><span class="header-section-number">11.4.3</span> 図の保存</a></li>
  </ul>
</li>
  </ul></nav>
    </div>
<!-- main -->
<main class="content page-columns page-full" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./part03.html">第3部 データの可視化</a></li><li class="breadcrumb-item"><a href="./chap11_visualization.html"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">ggplot2で可視化</span></a></li></ol></nav><div class="quarto-title">
<h1 class="title">
<span class="chapter-number">11</span>&nbsp; <span class="chapter-title">ggplot2で可視化</span>
</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header><p>ここではRの得意とする<strong>データの可視化</strong>(data visualization)について学びます。 いままで利用してきた<code>tidyverse</code>にはグラフ作成のためのパッケージとして<code>ggplot2</code>があります。 本章では，<code>ggplot2</code>の使い方を学習し，読者にもデータの特徴を伝えやすく，シンプルで，美しいグラフの作成を目指します。 ビッグデータを容易に扱えるようになった昨今において、データの可視化スキルの重要性は高まってきており、以下のような書籍が出版されています。いずれも非常に良い書籍ですので、興味のある方は読んでみてください。</p>
<div>

</div>
<div class="quarto-layout-panel" data-layout-ncol="3">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 33.3%;justify-content: flex-start;display: flex;">
<div class="img-fluid quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="img/R_Visu_01.jpg" class="img-fluid figure-img"></p>
<figcaption>データ分析のためのデータ可視化入門</figcaption></figure>
</div>
</div>
<div class="quarto-layout-cell" style="flex-basis: 33.3%;justify-content: flex-start;display: flex;">
<div class="img-fluid quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="img/R_Visu_02.jpg" class="img-fluid figure-img"></p>
<figcaption>Rでできるビジュアル統計学</figcaption></figure>
</div>
</div>
<div class="quarto-layout-cell" style="flex-basis: 33.3%;justify-content: flex-start;display: flex;">
<div class="img-fluid quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="img/R_Visu_03.jpg" class="img-fluid figure-img"></p>
<figcaption>Rによるインタラクティブなデータビジュアライゼーション</figcaption></figure>
</div>
</div>
</div>
</div>

<div class="no-row-height column-margin column-container"><div class="">
<p>1冊目はアメリカで絶賛された可視化本が翻訳されたものです。ソースコードとともに、データの可視化の基本や実例を学べます。 2冊目は、統計学を可視化という視点で学習する本です。 3冊目は前の2冊とは若干毛色が異なっており、<code>Shiny</code>というPosit社が開発したパッケージを使って、インタラクティブなグラフを作成する方法を学べます。</p>
</div></div><section id="可視化のパッケージ" class="level2" data-number="11.1"><h2 data-number="11.1" class="anchored" data-anchor-id="可視化のパッケージ">
<span class="header-section-number">11.1</span> 可視化のパッケージ</h2>
<p>いままで利用してきた<code>tidyverse</code>にはグラフ作成のためのパッケージとして<code>ggplot2</code>が含まれています。 本章では，この<code>ggplot2</code>パッケージの使い方を学習し，読者にもデータの特徴を伝えやすく，シンプルで，美しいグラフの作成を目指します。 また<code>ggplot2</code>の機能を拡張するための<code>ggthemes</code>と<code>patchwork</code>も一緒に読み込んでおきます。 まだインストールできていなければ，始めにインストールしておいてください。</p>
<div class="cell">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># install.packages("ggthemes") # fist time only</span></span>
<span><span class="co"># install.packages("patchwork") # first time only</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span> <span class="co"># とりあえずこれ</span></span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──
✔ dplyr     1.1.3     ✔ readr     2.1.4
✔ forcats   1.0.0     ✔ stringr   1.5.0
✔ ggplot2   3.4.2     ✔ tibble    3.2.1
✔ lubridate 1.9.2     ✔ tidyr     1.3.0
✔ purrr     1.0.2     
── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──
✖ dplyr::filter() masks stats::filter()
✖ dplyr::lag()    masks stats::lag()
ℹ Use the conflicted package (&lt;http://conflicted.r-lib.org/&gt;) to force all conflicts to become errors</code></pre>
</div>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/jrnold/ggthemes">ggthemes</a></span><span class="op">)</span> <span class="co"># ggplotのテーマ拡張</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://patchwork.data-imaginist.com">patchwork</a></span><span class="op">)</span> <span class="co"># ggplotの図を並べる</span></span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>また、Macだとggplot2で作図したグラフで日本語が表示されないことがあります。 以下の設定をすることで文字化けを回避することができます。</p>
<div class="cell">
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># グラフ内の日本語文字化け対策のおまじない</span></span>
<span><span class="fu">knitr</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/knitr/man/opts_chunk.html">opts_chunk</a></span><span class="op">$</span><span class="fu">set</span><span class="op">(</span>dev <span class="op">=</span> <span class="st">"ragg_png"</span><span class="op">)</span></span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>あるいは，<code>ggplot</code>のグラフ作成時に，<code>base_family = "フォント名"</code>として，作図で用いるフォントを指定することでも文字化けを回避できます。 たとえば次のように，<code><a href="https://rdrr.io/r/base/list.html">list()</a></code>関数を使ってグラフの設定を前もって<code>mystyle</code>というオブジェクトに入れておけば，作図時に<code>+ mystyle</code>を付けるだけで， フォントやグラフの見た目を指定できます。</p>
<div class="cell">
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">mystyle</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span> <span class="op">(</span> <span class="co"># mystyleとして設定を保存</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/ggthemes/man/theme_few.html">theme_few</a></span><span class="op">(</span><span class="op">)</span>, <span class="co"># ggthemesのテーマ</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span></span>
<span>    text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span></span>
<span>      size<span class="op">=</span><span class="fl">16</span>,  <span class="co">#  フォントサイズ</span></span>
<span>     family <span class="op">=</span> <span class="st">"HiraKakuProN-W3"</span> <span class="co"># ヒラギノフォント</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>以下の作図で使うデータを読み込んでおきましょう。</p>
<div class="cell">
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html">read_csv</a></span><span class="op">(</span><span class="st">"data/presemi_part_two.csv"</span><span class="op">)</span></span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Rows: 44527 Columns: 12
── Column specification ────────────────────────────────────────────────────────
Delimiter: ","
chr (3): 会社コード, 企業名, 決算期
dbl (9): 決算種別, 連結基準, 決算月数, 上場コード, 日経業種コード, 売上高, 親会社株主に帰属する当期純利益, 資産合計, 株主資本...

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
</div>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># df &lt;- read_csv("https://so-ichi.com/presemi_part_two.csv")</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span></span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "会社コード"                     "企業名"                        
 [3] "決算期"                         "決算種別"                      
 [5] "連結基準"                       "決算月数"                      
 [7] "上場コード"                     "日経業種コード"                
 [9] "売上高"                         "親会社株主に帰属する当期純利益"
[11] "資産合計"                       "株主資本"                      </code></pre>
</div>
</div>
<p>練習用の財務データを読み込み，オブジェクト<code>df</code>に代入しました。 <code>df</code>のクラスはspec_tbl_df, tbl_df, tbl, data.frameです。</p>
</section><section id="ggplotパッケージの基礎" class="level2" data-number="11.2"><h2 data-number="11.2" class="anchored" data-anchor-id="ggplotパッケージの基礎">
<span class="header-section-number">11.2</span> ggplotパッケージの基礎</h2>
<p>前節で、カテゴリー変数のファクター化，<code><a href="https://rdrr.io/r/base/with.html">with()</a></code>関数と<code><a href="https://rdrr.io/r/base/table.html">table()</a></code>関数を使ったクロス集計表の作成，<code><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by()</a></code>関数と<code><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize()</a></code>関数を使ったグループごとの統計量の計算について学んだので，これらの結果を使ってグラフを作ることで，読者に伝わるデータの可視化を行いたいと思います。 キレイなグラフを比較的簡単に作ることができる<code>ggplot2</code>パッケージを使います。</p>
<section id="ggplot関数の基本的な使い方と変数の特徴把握" class="level3" data-number="11.2.1"><h3 data-number="11.2.1" class="anchored" data-anchor-id="ggplot関数の基本的な使い方と変数の特徴把握">
<span class="header-section-number">11.2.1</span> <code>ggplot()</code>関数の基本的な使い方と変数の特徴把握</h3>
<p><code>ggplot2</code>パッケージの<code><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot()</a></code>関数は，次のような引数をとります。</p>
<ul>
<li>
<code>data =</code> : データフレーム</li>
<li>
<code>mapping = aes()</code> : グラフの構成要素を指定する関数</li>
<li>
<code>geom_***</code> : グラフの種類を指定する関数</li>
<li>各種オプション</li>
</ul>
<div class="img-fluid quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="img/ggplot_kiso.png" class="img-fluid figure-img"></p>
<figcaption>ggplot2の作図イメージ</figcaption></figure>
</div>
<p>最初の注意点として，<code><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot()</a></code>関数は，第1引数<code>data =</code>で<code>tibble</code>か<code>data.frame</code>を指定する必要があります。 データの型に気をつけましょう。</p>
<p>では，年度ごとに平均ROEを示した折れ線グラフを作図していきます。 ROEの定義は， <span class="math display">
ROE_{t} = \frac{\text{親会社株主に帰属する当期純利益}_t}{株主資本_{t-1}}
</span> となります。 計算してみましょう。 <code>決算期</code>の最初の4ケタを取り出し<code>年度</code>という変数も同時に作成しておきます。</p>
<div class="cell">
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">df</span> <span class="op">&lt;-</span> <span class="va">df</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">企業名</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="co"># lag()関数を使うために企業ごとにグループ化</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span> <span class="co"># ROEの計算</span></span>
<span>    年度 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/substr.html">substr</a></span><span class="op">(</span><span class="va">決算期</span>, <span class="fl">1</span>,<span class="fl">4</span><span class="op">)</span>,</span>
<span>    ROE <span class="op">=</span> <span class="va">親会社株主に帰属する当期純利益</span> <span class="op">/</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html">lag</a></span><span class="op">(</span><span class="va">株主資本</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>ROEの記述統計量を確認してみましょう。</p>
<div class="cell">
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">ROE</span><span class="op">)</span></span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   Min. 1st Qu.  Median    Mean 3rd Qu.    Max.    NA's 
   -Inf   0.026   0.068     NaN   0.119     Inf    3321 </code></pre>
</div>
</div>
<p><code>Min.</code>や<code>Max.</code>が<code>Inf</code>となっており， 欠損値<code>NA's</code>が3321個もあることが分かります。 <code>Inf</code>とは無限大を表す特殊な値で，ROEの計算プロセスで分母がゼロとなっている値があることが分かります。 分数を計算するときは，分母がゼロとなっている値がないかどうか，チェックするようにしましょう。 ついでに、総資産回転率も計算しておきます。</p>
<div class="cell">
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">df</span> <span class="op">&lt;-</span> <span class="va">df</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">株主資本</span> <span class="op">&gt;</span> <span class="fl">0</span>, <span class="va">資産合計</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="co"># ゼロのデータを除外</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">企業名</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="co"># 企業名でグループ化</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    ROE <span class="op">=</span> <span class="va">親会社株主に帰属する当期純利益</span> <span class="op">/</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html">lag</a></span><span class="op">(</span><span class="va">株主資本</span><span class="op">)</span>,</span>
<span>    TURN <span class="op">=</span> <span class="va">売上高</span> <span class="op">/</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html">lag</a></span><span class="op">(</span><span class="va">資産合計</span><span class="op">)</span> <span class="co"># 総資産回転率</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/drop_na.html">drop_na</a></span><span class="op">(</span><span class="op">)</span> <span class="co"># 欠損値NAを除外</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">ROE</span><span class="op">)</span></span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     Min.   1st Qu.    Median      Mean   3rd Qu.      Max. 
-32.16667   0.02692   0.06837   0.06600   0.11938 136.14286 </code></pre>
</div>
</div>
<p>これで最小値と最大値が計算されるようになりました。 次に，年度ごとの平均ROEを計算して、<code>df_year</code>というオブジェクトに代入しておきます。</p>
<div class="cell">
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">df_year</span> <span class="op">&lt;-</span> <span class="va">df</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">年度</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="co"># 年度ごとに</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span> <span class="co"># ROE平均を計算</span></span>
<span>    平均ROE <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">ROE</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="co"># グループ化解除</span></span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>これで準備が整ったので、<code><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot()</a></code>関数を使ってグラフを作成していきます。</p>
</section></section><section id="変数の可視化" class="level2 page-columns page-full" data-number="11.3"><h2 data-number="11.3" class="anchored" data-anchor-id="変数の可視化">
<span class="header-section-number">11.3</span> 1変数の可視化</h2>
<p>まずは，1変数の可視化から始めていきましょう。 1変数の可視化とは，1つの変数の分布を可視化することです。 1変数のグラフの代表的なものとして、<strong>ヒストグラム</strong>(histogram)があります。 <code>ggplot2</code>パッケージでは、</p>
<ul>
<li><code><a href="https://ggplot2.tidyverse.org/reference/geom_boxplot.html">geom_boxplot()</a></code></li>
</ul>
<p>で作図します。</p>
<p>まず土台となるデータフレームを指定します。 ここでは、年度別に集計する前の<code>df</code>を使います。</p>
<div class="cell">
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">df</span><span class="op">)</span></span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="chap11_visualization_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>土台ができましたが，まだ何も表示されていません。 次に，グラフの構成要素を指定するために，<code>mapping = aes()</code>で，軸を指定します。 1変数のグラフの場合、<code>aes(x = 変数名)</code>とすることで、変数を指定します。</p>
<div class="cell">
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">df</span>, mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">ROE</span><span class="op">)</span><span class="op">)</span></span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="chap11_visualization_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>作図する変数としてROEが指定されました。</p>
<section id="ヒストグラム" class="level3 page-columns page-full" data-number="11.3.1"><h3 data-number="11.3.1" class="anchored" data-anchor-id="ヒストグラム">
<span class="header-section-number">11.3.1</span> ヒストグラム</h3>
<p>ヒストグラムは、横軸に連続変数の区間をとり、その区間ごとの度数を縦軸にとったグラフで、連続変数の分布を可視化するのに適しています。 分布の偏りや外れ値の有無を確認するのに有用で、重要な変数に対して必ず作図するものと言えます。</p>
<p>ヒストグラムを作成するには、<code><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html">geom_histogram()</a></code>を使います。 <code><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot()</a></code>関数の引数を全て書くのは面倒なので、<code>data =</code>とか<code>mapping =</code>は省略します。</p>
<div class="cell">
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">ROE</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html">geom_histogram</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="chap11_visualization_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>

<div class="no-row-height column-margin column-container"><div class="">
<p>「<code><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html">stat_bin()</a></code> using <code>bins = 30</code>. Pick better value with <code>binwidth</code>.」というメッセージが出ました。 ヒストグラムを作成する際に区間幅やビンの数(棒の数)を指定しないと、<code>ggplot2</code>が自動的に30本の棒になるように区間幅を指定していますよ，というメッセージです。 好みの区間幅や棒の数を指定したい場合は，<code>binwidth = 0.1</code>のように指定してみてください。</p>
</div></div><div class="cell">
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">ROE</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html">geom_histogram</a></span><span class="op">(</span>binwidth <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span></span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="chap11_visualization_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>ヒストグラムが、ただの棒になっています。 これは大部分のデータがゼロ付近の値を取っているけれど、異常値があるせいで、横軸の範囲が広くなってしまっているためです。 先ほど計算したROEの記述統計量でも、最小値は<span class="math inline">-32.167</span>、最大値は<span class="math inline">136.143</span>となっています。 当期純利益が株主資本の136倍というのは、異常な値ですね。 そこで、<code>x</code>軸の範囲を<span class="math inline">[-1,1]</span>に限定してみましょう。 <code><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot()</a></code>関数に<code><a href="https://ggplot2.tidyverse.org/reference/lims.html">xlim()</a></code>を追加して、<code>x</code>軸の範囲を指定します。</p>
<div class="cell">
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">ROE</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html">geom_histogram</a></span><span class="op">(</span>binwidth <span class="op">=</span> <span class="fl">0.05</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html">xlim</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span></span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 319 rows containing non-finite values (`stat_bin()`).</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 2 rows containing missing values (`geom_bar()`).</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="chap11_visualization_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>

<div class="no-row-height column-margin column-container"><div class="">
<p>なにやら<code>Warning</code>が出ていますが、区間を区切ったことでグラフに入らなかったデータがあることを教えてくれているだけなので，無視します。</p>
</div></div><p>左右対称のヒストグラムが描けました。 ヒストグラムは分布の形や異常値を確認するためにも，分析する変数すべてに対して作成するように心がけましょう。</p>
</section></section><section id="変数の可視化-1" class="level2" data-number="11.4"><h2 data-number="11.4" class="anchored" data-anchor-id="変数の可視化-1">
<span class="header-section-number">11.4</span> 2変数の可視化</h2>
<p>次に，2変数の可視化を行っていきましょう。 2変数の可視化では、横軸と縦軸にそれぞれ1つの変数をとるグラフを作成します。 また、横軸に割り当てられる変数が連続変数かカテゴリー変数かによって、作成するグラフが異なります。</p>
<section id="横軸が連続縦軸も連続の場合" class="level3" data-number="11.4.1"><h3 data-number="11.4.1" class="anchored" data-anchor-id="横軸が連続縦軸も連続の場合">
<span class="header-section-number">11.4.1</span> 横軸が連続・縦軸も連続の場合</h3>
<p>横軸と縦軸の両方が連続変数の場合、2つの変数の関係性を表すグラフとして<strong>散布図</strong>(scatter plot)を作成します。 散布図は、横軸の値と対応する縦軸の値の組み合わせを点で表したグラフです。 散布図は、<code><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point()</a></code>を使って作成します。</p>
<p>先ほど作成した<code>df</code>の<code>ROE</code>と<code>TURN</code>の関係を散布図で表してみましょう。 先と同様に、<code>x</code>軸と<code>y</code>軸の範囲をしておきます。</p>
<div class="cell">
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">ROE</span>, <span class="va">TURN</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html">xlim</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html">ylim</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">10</span><span class="op">)</span></span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 322 rows containing missing values (`geom_point()`).</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="chap11_visualization_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>なんとなく、総資産回転率<code>TURN</code>が大きいほど、<code>ROE</code>が大きいように見えます。 このように、散布図を作成すると、2つの変数の関係を直観的に把握することができます。</p>
</section><section id="横軸がカテゴリー変数縦軸が連続変数の場合" class="level3" data-number="11.4.2"><h3 data-number="11.4.2" class="anchored" data-anchor-id="横軸がカテゴリー変数縦軸が連続変数の場合">
<span class="header-section-number">11.4.2</span> 横軸がカテゴリー変数・縦軸が連続変数の場合</h3>
<p>横軸が順序のないカテゴリー変数で、縦軸が連続変数となるグラフとして</p>
<ul>
<li>
<code><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar()</a></code> : 棒グラフ</li>
<li>
<code><a href="https://ggplot2.tidyverse.org/reference/geom_boxplot.html">geom_boxplot()</a></code> : 箱ひげ図</li>
<li>
<code><a href="https://ggplot2.tidyverse.org/reference/geom_violin.html">geom_violin()</a></code> : バイオリンプロット</li>
</ul>
<p>などがあり、横軸が順序のあるカテゴリー変数であれば、</p>
<ul>
<li>
<code><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line()</a></code> : 折れ線グラフ</li>
</ul>
<p>が代表的です。 また，横軸にカテゴリー変数を指定する際に，そのカテゴリー変数の型が数値型でも文字列でも因子型でも，Rが適切に解釈してくれ，作図してくれますが，可能な限りカテゴリー変数は因子型にしておくほうが望ましいです。</p>
<!--
横軸がカテゴリー変数で縦軸が連続変数の場合、カテゴリーごとの連続変数の分布を表すグラフとして**箱ひげ図**(box plot)を作成します。
-->
<p>それぞれ作成してみましょう。</p>
<section id="棒グラフ" class="level4" data-number="11.4.2.1"><h4 data-number="11.4.2.1" class="anchored" data-anchor-id="棒グラフ">
<span class="header-section-number">11.4.2.1</span> 棒グラフ</h4>
<p>棒グラフはヒストグラムに似ていますが、<strong>棒グラフは離散変数やカテゴリー変数の分布を表し</strong>、ヒストグラムは連続変数の分布を表している、という点で違いがあります。</p>
<p>棒グラフを作成するには、<code><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar()</a></code>を使います。 <code><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar()</a></code>は次の引数をとります。</p>
<ul>
<li>
<code>stat =</code> : 棒の高さの計算方法 <code>identity</code>を指定すると、データの値をそのまま棒の高さにします。</li>
<li>
<code>position =</code> : 棒の位置の計算方法 <code>dodge</code>を指定すると、カテゴリーごとに棒を並べます。</li>
</ul>
<p>また、2変数のグラフとなるため、<code>aes(x = 変数1, y = 変数2)</code>と2つの変数を指定します。 ここでは年度ごとに集計した<code>df_year</code>を使って、年度ごとの平均ROEを棒グラフで表してみましょう。</p>
<div class="cell">
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">df_year</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">年度</span>, y <span class="op">=</span> <span class="va">平均ROE</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar</a></span><span class="op">(</span>stat <span class="op">=</span> <span class="st">"identity"</span><span class="op">)</span></span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="chap11_visualization_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section><section id="箱ひげ図" class="level4" data-number="11.4.2.2"><h4 data-number="11.4.2.2" class="anchored" data-anchor-id="箱ひげ図">
<span class="header-section-number">11.4.2.2</span> 箱ひげ図</h4>
<p>箱ひげ図(box plot)は、カテゴリーごとの連続変数の分布を表すグラフです。 棒と箱の図からなるグラフで、箱の部分から中央値(Q2)，第1四分位点(Q1)，第3四分位点(Q3)統計量，そしてヒゲの部分から正常値と設定される範囲が読み取れるグラフです。 <!-- 箱の下辺は第1四分位(Q1)で、上辺は第3四分位(Q3)を表しています。 --></p>
<div class="img-fluid quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="img/geom_boxplot.png" class="img-fluid figure-img"></p>
<figcaption>箱ひげ図</figcaption></figure>
</div>
<p>年度ごとのROEの分布を箱ひげ図で表してみましょう。 横軸のカテゴリー変数ごとに作図するため，<code><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes()</a></code>の中で<code>x</code>軸と<code>y</code>軸を設定するのと同時に，<code>group =</code>でカテゴリーを指示します。</p>
<p>では集計前の<code>df</code>を用いて，上場コードごとの<code>ROE</code>の分布を表す箱ひげ図を作成します。 異常値のせいで箱ひげ図が潰れてしまうことが予想できるので，表示する幅を<code><a href="https://ggplot2.tidyverse.org/reference/lims.html">ylim()</a></code>で設定しておきます。</p>
<div class="cell">
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">df</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">上場コード</span>, y <span class="op">=</span> <span class="va">ROE</span>, group <span class="op">=</span> <span class="va">上場コード</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_boxplot.html">geom_boxplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html">ylim</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.5</span>, <span class="fl">0.5</span><span class="op">)</span></span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 1168 rows containing non-finite values (`stat_boxplot()`).</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="chap11_visualization_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>この上場場ごとのROEの箱ひげ図から，東証プライム(東証1部)に属する企業は，ROEの中央値が他よりも高いが，東証スタンダードとグロースは中央値に差が無さそうに見える。しかし東証グロースはROEのばらつきが最も大きく，業績の格差が大きいことが分かる。</p>
</section><section id="ヴァイオリンプロット" class="level4" data-number="11.4.2.3"><h4 data-number="11.4.2.3" class="anchored" data-anchor-id="ヴァイオリンプロット">
<span class="header-section-number">11.4.2.3</span> ヴァイオリンプロット</h4>
<p>次に，バイオリンプロットを作成します。 バイオリン・プロットも箱ひげ図を同じようなグラフですが，分布の形を中央値などの代表値で表すのではなく，分布の形をそのまま表現することができます。 バイオリンプロットの作成には<code><a href="https://ggplot2.tidyverse.org/reference/geom_violin.html">geom_violin()</a></code>を使います。</p>
<div class="cell">
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">g</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">上場コード</span><span class="op">)</span>, y <span class="op">=</span> <span class="va">ROE</span><span class="op">)</span></span>
<span><span class="va">g</span> <span class="op">&lt;-</span> <span class="va">g</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_violin.html">geom_violin</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html">ylim</a></span><span class="op">(</span><span class="op">-</span><span class="fl">.5</span>,<span class="fl">.5</span><span class="op">)</span></span>
<span><span class="va">g</span> <span class="op">&lt;-</span> <span class="va">g</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span><span class="op">(</span><span class="st">"上場場"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span><span class="op">(</span><span class="st">"ROE"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">g</span><span class="op">)</span></span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 1168 rows containing non-finite values (`stat_ydensity()`).</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="chap11_visualization_files/figure-html/unnamed-chunk-16-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>バイオリンプロットから，プライム・東証1部とスタンダード・東証2部の上場企業のROEは中央値に差があるものの，分布の形は似ていますが，グロース・マザーズの企業は，ROEの分布が大きく異なることがわかります。</p>
</section><section id="カスタマイズした箱ひげ図とバイオリンプロット" class="level4" data-number="11.4.2.4"><h4 data-number="11.4.2.4" class="anchored" data-anchor-id="カスタマイズした箱ひげ図とバイオリンプロット">
<span class="header-section-number">11.4.2.4</span> カスタマイズした箱ひげ図とバイオリンプロット</h4>
<p><code><a href="https://ggplot2.tidyverse.org/reference/geom_violin.html">geom_violin()</a></code>をもっとカスタマイズして，より豊かな情報をもつグラフにしてみようと思います。 まずは，グラフを色分けしてみましょう。 <code><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes()</a></code>の中で<code>fill =</code>で色を指定します。 ついでに，<code><a href="https://ggplot2.tidyverse.org/reference/geom_dotplot.html">geom_dotplot()</a></code>を使って，データの分布を点で表現してみます。</p>
<div class="cell">
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">g</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">上場コード</span><span class="op">)</span>, y <span class="op">=</span> <span class="va">ROE</span>, fill <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">上場コード</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">g</span> <span class="op">&lt;-</span> <span class="va">g</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_violin.html">geom_violin</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">g</span> <span class="op">&lt;-</span> <span class="va">g</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_boxplot.html">geom_boxplot</a></span><span class="op">(</span>width <span class="op">=</span> <span class="fl">0.1</span>, fill <span class="op">=</span> <span class="st">"white"</span>, color <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span></span>
<span><span class="va">g</span> <span class="op">&lt;-</span> <span class="va">g</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html">ylim</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.5</span>, <span class="fl">0.5</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">g</span><span class="op">)</span></span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 1168 rows containing non-finite values (`stat_ydensity()`).</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 1168 rows containing non-finite values (`stat_boxplot()`).</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="chap11_visualization_files/figure-html/unnamed-chunk-17-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section><section id="折れ線グラフ" class="level4" data-number="11.4.2.5"><h4 data-number="11.4.2.5" class="anchored" data-anchor-id="折れ線グラフ">
<span class="header-section-number">11.4.2.5</span> 折れ線グラフ</h4>
<p><strong>横軸が時間を表すカテゴリー変数</strong>である場合，データの時系列的特性を表すために折れ線グラフを作成します。</p>
<p>折れ線グラフを作成するためには<code><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line()</a></code>関数を使います。 年度平均を集計した<code>df_year</code>を用いて，横軸が<code>年度</code>，縦軸が<code>平均ROE</code>となる折れ線グラフを作成し，上場企業全体のROE平均が時間とともにどのように変化したのかを確認してみましょう。 ここで<code>年度</code>が文字列となっていますが，本来は<strong>順序に意味のあるカテゴリー変数</strong>ですので，<code><a href="https://rdrr.io/r/base/factor.html">factor()</a></code>関数を使って，ファクター型に変換します。</p>
<div class="cell">
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">df_year</span> <span class="op">&lt;-</span> <span class="va">df_year</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    年度 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span> <span class="co"># 因子型に変換</span></span>
<span>      <span class="va">年度</span>, <span class="co"># 因子型にする変数</span></span>
<span>      levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1999</span><span class="op">:</span><span class="fl">2022</span><span class="op">)</span>, <span class="co"># カテゴリーの種類</span></span>
<span>      ordered <span class="op">=</span> <span class="cn">TRUE</span> <span class="co"># 順序があることを明示</span></span>
<span>      <span class="op">)</span></span>
<span>      <span class="op">)</span></span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">df_year</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">年度</span>, y <span class="op">=</span> <span class="va">平均ROE</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`geom_line()`: Each group consists of only one observation.
ℹ Do you need to adjust the group aesthetic?</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="chap11_visualization_files/figure-html/unnamed-chunk-19-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>「<code><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line()</a></code>: Each group consists of only one observation. Do you need to adjust the group aesthetic?」というメッセージが出ました。</p>
<p>これは，<code>年度</code>が因子型であり，<code>ggplot2</code>が自動的に<code>年度</code>ごとにグループ分けをしてくれないために出るメッセージです。 <code><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes()</a></code>の中で<code>group = 1</code>として，データ全体が1つのグループであることを明示する必要があります。 横軸がファクター型であるときは，<code>group = 1</code>をつける，というおまじないを覚えておきましょう。</p>
<div class="cell">
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">df_year</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">年度</span>, y <span class="op">=</span> <span class="va">平均ROE</span>, group <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="co"># グラフ</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span><span class="op">(</span><span class="st">"年度"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span><span class="op">(</span><span class="st">"平均ROE"</span><span class="op">)</span> <span class="co"># 軸ラベル</span></span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="chap11_visualization_files/figure-html/unnamed-chunk-20-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>上のようにすべての要素を<code>+</code>でつなぐよりも，レイヤーごとにオブジェクトに代入していくほうが，コードが読みやすくなります。 以下の例では，グラフの基本要素を<code>g</code>というオブジェクトに代入しておき，<code>g &lt;- g +</code>でどんどんレイヤーを追加していきます。</p>
<div class="cell">
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">g</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">df_year</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">年度</span>, <span class="va">平均ROE</span>, group <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="co"># 基本要素</span></span>
<span><span class="va">g</span> <span class="op">&lt;-</span> <span class="va">g</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="co"># 折れ線グラフと散布図</span></span>
<span><span class="va">g</span> <span class="op">&lt;-</span> <span class="va">g</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span><span class="op">(</span><span class="st">"年度"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span><span class="op">(</span><span class="st">"平均ROE"</span><span class="op">)</span> <span class="co"># 見た目の調整</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">g</span><span class="op">)</span></span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>折れ線グラフだけより，散布図も同時に表示するほうがグラフが読みやすくなり，オススメです。</p>
<!---

### ヒストグラム

次に，前年度のROEのヒストグラムを作成してみましょう。



::: {.cell}

```{.r .cell-code}
g <- ggplot(df) +
  aes(ROE) + # 1変数 ROE を指定
  geom_histogram(fill="skyblue", color = "black") + # ヒストグラム
  xlim(-1,1) + mystyle # x軸の範囲とスタイルを指定
print(g)
```

::: {.cell-output .cell-output-stderr}

```
`stat_bin()` using `bins = 30`. Pick better value with `binwidth`.
```


:::

::: {.cell-output .cell-output-stderr}

```
Warning: Removed 319 rows containing non-finite values (`stat_bin()`).
```


:::

::: {.cell-output .cell-output-stderr}

```
Warning: Removed 2 rows containing missing values (`geom_bar()`).
```


:::

::: {.cell-output-display}
![](chap11_visualization_files/figure-html/unnamed-chunk-22-1.png){width=672}
:::
:::




### 箱ひげ図とバイオリンプロット

次に，上場場所別ROEの分布を箱ひげ図とバイオリンプロットで比較してみましょう。
箱ひげ図は，`geom_boxplot()`を使います。


::: {.cell}

```{.r .cell-code}
g <- ggplot(df) + aes(x = factor(上場コード), y = ROE) + geom_boxplot() + mystyle
print(g)
```

::: {.cell-output-display}
![](chap11_visualization_files/figure-html/unnamed-chunk-23-1.png){width=672}
:::
:::


ROEのばらつきが大きく，極端にROEが大きかったり小さかったりする異常値のせいで，箱ひげ図がうまく描写されていません。
そこで異常値を除外するため，ROEの範囲を$[-0.5,0.5]$に限定してみましょう。
先ほど箱ひげ図を作成するために作ったオブジェクト`g`に`ylim()`を追加して，Y軸の範囲を指定します。

::: {.cell}

```{.r .cell-code}
g <- g + ylim(-.5,.5) # y軸の範囲を指定
print(g)
```

::: {.cell-output .cell-output-stderr}

```
Warning: Removed 1168 rows containing non-finite values (`stat_boxplot()`).
```


:::

::: {.cell-output-display}
![](chap11_visualization_files/figure-html/unnamed-chunk-24-1.png){width=672}
:::
:::

箱ひげ図の箱の下辺は第1四分位(Q1)で，上辺は第3四分位(Q3)です。
真ん中の太い横棒は中央値です。 箱から出ているひげはデータの四分位範囲を超えた値の範囲ですが，黒丸は外れ値を表しています。

次に，バイオリンプロットを作成します。
バイオリンプロットもほぼ箱ひげ図と同じですが，`geom_violin()`を使います。


::: {.cell}

```{.r .cell-code}
g <- ggplot(df) + aes(x = factor(上場コード), y = ROE)
g <- g + geom_violin() + ylim(-.5,.5) + mystyle
print(g)
```

::: {.cell-output .cell-output-stderr}

```
Warning: Removed 1168 rows containing non-finite values (`stat_ydensity()`).
```


:::

::: {.cell-output-display}
![](chap11_visualization_files/figure-html/unnamed-chunk-25-1.png){width=672}
:::
:::


箱ひげ図やバイオリンプロットから，東証1部と東証2部の上場企業のROEは中央値に差があるものの，分布の形は似ていますが，マザーズの企業は，ROEの分布が大きく異なることがわかります。

--->
</section></section><section id="図の保存" class="level3" data-number="11.4.3"><h3 data-number="11.4.3" class="anchored" data-anchor-id="図の保存">
<span class="header-section-number">11.4.3</span> 図の保存</h3>
<p>最後に，作成した図を保存するには，<code><a href="https://ggplot2.tidyverse.org/reference/ggsave.html">ggsave()</a></code>関数を使います。 <code><a href="https://ggplot2.tidyverse.org/reference/ggsave.html">ggsave()</a></code>関数は，次のような引数をとります。</p>
<ul>
<li>
<code>filename =</code> : 保存するファイル名</li>
<li>
<code>plot =</code> : 保存する図</li>
<li>
<code>width =</code> : 図の幅</li>
<li>
<code>height =</code> : 図の高さ</li>
<li>
<code>dpi =</code> : 解像度</li>
</ul>
<p>日本語を含まないグラフであったり，Windowsならこれでうまくいくのですが，Macで日本語を含むggplotのグラフを保存するには一手間必要です。</p>
<section id="macの場合" class="level4 unnumbered"><h4 class="unnumbered anchored" data-anchor-id="macの場合">Macの場合</h4>
<p>Macの場合，<code><a href="https://ggplot2.tidyverse.org/reference/ggsave.html">ggsave()</a></code>関数を使って図を保存しても，日本語が文字化けして保存されてしまいます。 そこで<code><a href="https://rdrr.io/r/grDevices/quartz.html">quartz()</a></code>関数を用いて保存すれば日本語を含むグラフを文字化けさせずに保存することができます。</p>
<p><code><a href="https://rdrr.io/r/grDevices/quartz.html">quartz()</a></code>は以下の引数を取ります。</p>
<ul>
<li>
<code>filename =</code> : 保存するファイル名</li>
<li>
<code>width =</code> : 図の幅</li>
<li>
<code>height =</code> : 図の高さ</li>
<li>
<code>pointsize =</code> : フォントサイズ</li>
<li>
<code>dpi =</code> : 解像度</li>
<li>
<code>family =</code> : フォントファミリー</li>
<li>
<code>type =</code> : ファイルタイプ</li>
<li>
<code>antialias =</code> : アンチエイリアス</li>
</ul>
<p>最低限の設定だと,</p>
<p><code>quartz("ファイル名.pdf", type = "pdf")</code>とか，<code>quartz("ファイル名.png", type = "png")</code>と，保存するファイル名とファイルタイプを指定しておきましょう。 その上で，</p>
<ol type="1">
<li>
<code><a href="https://rdrr.io/r/grDevices/quartz.html">quartz()</a></code>関数でグラフを保存するファイルを指定する</li>
<li>
<code><a href="https://rdrr.io/r/base/print.html">print()</a></code>関数でグラフを表示・保存</li>
<li>
<code><a href="https://rdrr.io/r/grDevices/dev.html">dev.off()</a></code>関数で保存を終了する</li>
</ol>
<p>という手順を踏むと，作業ディレクトリにグラフが保存されます。</p>
<div class="cell">
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/grDevices/quartz.html">quartz</a></span><span class="op">(</span><span class="st">"violin_plot.pdf"</span>, width <span class="op">=</span> <span class="fl">10</span>, height <span class="op">=</span> <span class="fl">6</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">g</span><span class="op">)</span> <span class="co"># グラフが代入されたオブジェクトを表示</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/grDevices/dev.html">dev.off</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>これで作業ディレクトリに<code>violin_plot.pdf</code>が保存されました。</p>


</section></section></section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "コピーしました");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "コピーしました");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
          // default icon
          link.classList.add("external");
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      return note.innerHTML;
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="./part03.html" class="pagination-link  aria-label=">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">第3部 データの可視化</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./chap12_ggpubr.html" class="pagination-link" aria-label="<span class='chapter-number'>12</span>&nbsp; <span class='chapter-title'>ggpubrで可視化</span>">
        <span class="nav-page-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">ggpubrで可視化</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer"><div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
<p>Copyright 2024, Soichi Matsuura</p>
</div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>


</body></html>